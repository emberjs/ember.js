import { parse } from '@babel/parser';
import { traverse } from '@babel/core';
import { readFileSync, writeFileSync } from 'node:fs';
import { resolve } from 'node:path';
import { createRequire } from 'node:module';
import { fileURLToPath } from 'node:url';

const require = createRequire(import.meta.url);
const ts = require.resolve('typescript');
const libDomFile = resolve(ts, '..', 'lib.dom.d.ts');
const source = readFileSync(libDomFile).toString();
const ast = parse(source, {
  plugins: [['typescript', { dts: true }]],
});

let htmlElements = new Set(['HTMLElement']);
let svgElements = new Set(['SVGElement']);

traverse(ast, {
  TSInterfaceDeclaration(path) {
    switch (path.node.id.name) {
      case 'HTMLElementTagNameMap': {
        path.node.body.body.forEach(({ typeAnnotation }) => {
          htmlElements.add(typeAnnotation.typeAnnotation.typeName.name);
        });

        break;
      }

      case 'SVGElementTagNameMap': {
        path.node.body.body.forEach(({ typeAnnotation }) => {
          svgElements.add(typeAnnotation.typeAnnotation.typeName.name);
        });

        break;
      }
    }
  },
});

htmlElements = new Set([...htmlElements].sort());
svgElements = new Set([...svgElements].sort());

const filePath = resolve(
  fileURLToPath(import.meta.url),
  '../-private/dsl/lib.dom.augmentation.d.ts'
);

writeFileSync(
  filePath,
  [
    `// Auto-generated by bin/build-augmentations.mjs`,
    `//`,
    `// This serves to provide a UNIQUE mapping for element type -> element name -> element attributes`,
    `//   (in combination with elements.d.ts)`,
    `//`,
    `// The TypeScript lib.dom.d.ts already has HTMLElementTagNameMap,`,
    `// but it does not provide unique types for each element, and the technique`,
    `// we use for looking up the type-string for each element does not work with the built in types.`,
    ``,
    `export type HTMLElementMap = {`,
    ...Array.from(htmlElements).map((elementType) => {
      return `  '${elementType}': ${elementType};`;
    }),
    `};`,
    ``,
    `export type SVGElementMap = {`,
    ...Array.from(svgElements).map((elementType) => {
      return `  '${elementType}': ${elementType};`;
    }),
    `};`,
    ``,
  ].join('\n')
);

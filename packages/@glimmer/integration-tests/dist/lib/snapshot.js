import { replaceHTML, toInnerHTML } from './dom/simple-utils';
import { tokenize } from 'simple-html-tokenizer';
export function snapshotIsNode(snapshot) {
    return snapshot !== 'up' && snapshot !== 'down';
}
export function equalTokens(testFragment, testHTML, message = null) {
    if (testFragment === null) {
        throw new Error(`Unexpectedly passed null to equalTokens`);
    }
    let fragTokens = generateTokens(testFragment);
    let htmlTokens = generateTokens(testHTML);
    // let msg = "Expected: " + htmlTokens.html + "; Actual: " + fragTokens.html;
    // if (message) { msg += " (" + message + ")"; }
    let equiv = QUnit.equiv(fragTokens.tokens, htmlTokens.tokens);
    if (equiv && fragTokens.html !== htmlTokens.html) {
        QUnit.assert.deepEqual(fragTokens.tokens, htmlTokens.tokens, message || 'expected tokens to match');
    }
    else {
        QUnit.assert.pushResult({
            result: QUnit.equiv(fragTokens.tokens, htmlTokens.tokens),
            actual: fragTokens.html,
            expected: htmlTokens.html,
            message: message || 'expected tokens to match',
        });
    }
    // QUnit.assert.deepEqual(fragTokens.tokens, htmlTokens.tokens, msg);
}
function isMarker(node) {
    if (node.nodeType === 8 /* COMMENT_NODE */ && node.nodeValue === '') {
        return true;
    }
    if (node.nodeType === 3 /* TEXT_NODE */ && node.nodeValue === '') {
        return true;
    }
    return false;
}
export function generateSnapshot(element) {
    let snapshot = [];
    let node = element.firstChild;
    while (node) {
        if (!isMarker(node)) {
            snapshot.push(node);
        }
        node = node.nextSibling;
    }
    return snapshot;
}
function generateTokens(divOrHTML) {
    let div;
    if (typeof divOrHTML === 'string') {
        div = document.createElement('div');
        replaceHTML(div, divOrHTML);
    }
    else {
        div = divOrHTML;
    }
    let tokens = tokenize(toInnerHTML(div), {});
    tokens = tokens.reduce((tokens, token) => {
        if (token.type === 'StartTag') {
            if (token.attributes) {
                token.attributes.sort((a, b) => {
                    if (a[0] > b[0]) {
                        return 1;
                    }
                    if (a[0] < b[0]) {
                        return -1;
                    }
                    return 0;
                });
            }
            if (token.selfClosing) {
                token.selfClosing = false;
                tokens.push(token);
                tokens.push({ type: 'EndTag', tagName: token.tagName });
            }
            else {
                tokens.push(token);
            }
        }
        else {
            tokens.push(token);
        }
        return tokens;
    }, new Array());
    return { tokens, html: toInnerHTML(div) };
}
export function equalSnapshots(a, b) {
    QUnit.assert.strictEqual(a.length, b.length, 'Same number of nodes');
    for (let i = 0; i < b.length; i++) {
        QUnit.assert.strictEqual(a[i], b[i], 'Nodes are the same');
    }
}
export function isServerMarker(node) {
    return node.nodeType === 8 /* COMMENT_NODE */ && node.nodeValue.charAt(0) === '%';
}
export function normalizeSnapshot(oldSnapshot, newSnapshot, except) {
    let oldIterator = new SnapshotIterator(oldSnapshot);
    let newIterator = new SnapshotIterator(newSnapshot);
    let normalizedOld = [];
    let normalizedNew = [];
    while (true) {
        let nextOld = oldIterator.peek();
        let nextNew = newIterator.peek();
        if (nextOld === null && newIterator.peek() === null)
            break;
        if ((nextOld && snapshotIsNode(nextOld) && except.indexOf(nextOld) > -1) ||
            (nextNew && snapshotIsNode(nextNew) && except.indexOf(nextNew) > -1)) {
            oldIterator.skip();
            newIterator.skip();
        }
        else {
            normalizedOld.push(oldIterator.next());
            normalizedNew.push(newIterator.next());
        }
    }
    return { oldSnapshot: normalizedOld, newSnapshot: normalizedNew };
}
class SnapshotIterator {
    constructor(snapshot) {
        this.snapshot = snapshot;
        this.depth = 0;
        this.pos = 0;
    }
    peek() {
        if (this.pos >= this.snapshot.length)
            return null;
        return this.snapshot[this.pos];
    }
    next() {
        if (this.pos >= this.snapshot.length)
            return null;
        return this.nextNode() || null;
    }
    skip() {
        let skipUntil = this.depth;
        this.nextNode();
        if (this.snapshot[this.pos] === 'down') {
            do {
                this.nextNode();
            } while (this.depth !== skipUntil);
        }
    }
    nextNode() {
        let token = this.snapshot[this.pos++];
        if (token === 'down') {
            this.depth++;
        }
        else if (token === 'up') {
            this.depth--;
        }
        return token;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic25hcHNob3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9saWIvc25hcHNob3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM5RCxPQUFPLEVBQUUsUUFBUSxFQUFpQixNQUFNLHVCQUF1QixDQUFDO0FBS2hFLE1BQU0sVUFBVSxjQUFjLENBQUMsUUFBNEI7SUFDekQsT0FBTyxRQUFRLEtBQUssSUFBSSxJQUFJLFFBQVEsS0FBSyxNQUFNLENBQUM7QUFDbEQsQ0FBQztBQUVELE1BQU0sVUFBVSxXQUFXLENBQ3pCLFlBQTJDLEVBQzNDLFFBQWdDLEVBQ2hDLFVBQTBCLElBQUk7SUFFOUIsSUFBSSxZQUFZLEtBQUssSUFBSSxFQUFFO1FBQ3pCLE1BQU0sSUFBSSxLQUFLLENBQUMseUNBQXlDLENBQUMsQ0FBQztLQUM1RDtJQUVELElBQUksVUFBVSxHQUFHLGNBQWMsQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUM5QyxJQUFJLFVBQVUsR0FBRyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFMUMsNkVBQTZFO0lBRTdFLGdEQUFnRDtJQUVoRCxJQUFJLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBRTlELElBQUksS0FBSyxJQUFJLFVBQVUsQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDLElBQUksRUFBRTtRQUNoRCxLQUFLLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FDcEIsVUFBVSxDQUFDLE1BQU0sRUFDakIsVUFBVSxDQUFDLE1BQU0sRUFDakIsT0FBTyxJQUFJLDBCQUEwQixDQUN0QyxDQUFDO0tBQ0g7U0FBTTtRQUNMLEtBQUssQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDO1lBQ3RCLE1BQU0sRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsVUFBVSxDQUFDLE1BQU0sQ0FBQztZQUN6RCxNQUFNLEVBQUUsVUFBVSxDQUFDLElBQUk7WUFDdkIsUUFBUSxFQUFFLFVBQVUsQ0FBQyxJQUFJO1lBQ3pCLE9BQU8sRUFBRSxPQUFPLElBQUksMEJBQTBCO1NBQy9DLENBQUMsQ0FBQztLQUNKO0lBRUQscUVBQXFFO0FBQ3ZFLENBQUM7QUFFRCxTQUFTLFFBQVEsQ0FBQyxJQUFnQjtJQUNoQyxJQUFJLElBQUksQ0FBQyxRQUFRLHlCQUEwQixJQUFJLElBQUksQ0FBQyxTQUFTLEtBQUssRUFBRSxFQUFFO1FBQ3BFLE9BQU8sSUFBSSxDQUFDO0tBQ2I7SUFFRCxJQUFJLElBQUksQ0FBQyxRQUFRLHNCQUF1QixJQUFJLElBQUksQ0FBQyxTQUFTLEtBQUssRUFBRSxFQUFFO1FBQ2pFLE9BQU8sSUFBSSxDQUFDO0tBQ2I7SUFFRCxPQUFPLEtBQUssQ0FBQztBQUNmLENBQUM7QUFFRCxNQUFNLFVBQVUsZ0JBQWdCLENBQUMsT0FBc0I7SUFDckQsSUFBSSxRQUFRLEdBQWlCLEVBQUUsQ0FBQztJQUNoQyxJQUFJLElBQUksR0FBdUIsT0FBTyxDQUFDLFVBQVUsQ0FBQztJQUVsRCxPQUFPLElBQUksRUFBRTtRQUNYLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDbkIsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUNyQjtRQUNELElBQUksR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDO0tBQ3pCO0lBRUQsT0FBTyxRQUFRLENBQUM7QUFDbEIsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLFNBQWlDO0lBQ3ZELElBQUksR0FBa0IsQ0FBQztJQUN2QixJQUFJLE9BQU8sU0FBUyxLQUFLLFFBQVEsRUFBRTtRQUNqQyxHQUFHLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQWtCLENBQUM7UUFDckQsV0FBVyxDQUFDLEdBQUcsRUFBRSxTQUFTLENBQUMsQ0FBQztLQUM3QjtTQUFNO1FBQ0wsR0FBRyxHQUFHLFNBQVMsQ0FBQztLQUNqQjtJQUVELElBQUksTUFBTSxHQUFHLFFBQVEsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFFNUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEVBQUU7UUFDdkMsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLFVBQVUsRUFBRTtZQUM3QixJQUFJLEtBQUssQ0FBQyxVQUFVLEVBQUU7Z0JBQ3BCLEtBQUssQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUM3QixJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7d0JBQ2YsT0FBTyxDQUFDLENBQUM7cUJBQ1Y7b0JBQ0QsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFO3dCQUNmLE9BQU8sQ0FBQyxDQUFDLENBQUM7cUJBQ1g7b0JBQ0QsT0FBTyxDQUFDLENBQUM7Z0JBQ1gsQ0FBQyxDQUFDLENBQUM7YUFDSjtZQUVELElBQUksS0FBSyxDQUFDLFdBQVcsRUFBRTtnQkFDckIsS0FBSyxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7Z0JBQzFCLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ25CLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTyxFQUFZLENBQUMsQ0FBQzthQUNuRTtpQkFBTTtnQkFDTCxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ3BCO1NBQ0Y7YUFBTTtZQUNMLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDcEI7UUFFRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDLEVBQUUsSUFBSSxLQUFLLEVBQVMsQ0FBQyxDQUFDO0lBRXZCLE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLFdBQVcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO0FBQzVDLENBQUM7QUFFRCxNQUFNLFVBQVUsY0FBYyxDQUFDLENBQWUsRUFBRSxDQUFlO0lBQzdELEtBQUssQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO0lBQ3JFLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ2pDLEtBQUssQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsb0JBQW9CLENBQUMsQ0FBQztLQUM1RDtBQUNILENBQUM7QUFFRCxNQUFNLFVBQVUsY0FBYyxDQUFDLElBQWdCO0lBQzdDLE9BQU8sSUFBSSxDQUFDLFFBQVEseUJBQTBCLElBQUksSUFBSSxDQUFDLFNBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDO0FBQ3RGLENBQUM7QUFFRCxNQUFNLFVBQVUsaUJBQWlCLENBQy9CLFdBQTBCLEVBQzFCLFdBQTBCLEVBQzFCLE1BQXlCO0lBRXpCLElBQUksV0FBVyxHQUFHLElBQUksZ0JBQWdCLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDcEQsSUFBSSxXQUFXLEdBQUcsSUFBSSxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUVwRCxJQUFJLGFBQWEsR0FBRyxFQUFFLENBQUM7SUFDdkIsSUFBSSxhQUFhLEdBQUcsRUFBRSxDQUFDO0lBRXZCLE9BQU8sSUFBSSxFQUFFO1FBQ1gsSUFBSSxPQUFPLEdBQUcsV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2pDLElBQUksT0FBTyxHQUFHLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUVqQyxJQUFJLE9BQU8sS0FBSyxJQUFJLElBQUksV0FBVyxDQUFDLElBQUksRUFBRSxLQUFLLElBQUk7WUFBRSxNQUFNO1FBRTNELElBQ0UsQ0FBQyxPQUFPLElBQUksY0FBYyxDQUFDLE9BQU8sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDcEUsQ0FBQyxPQUFPLElBQUksY0FBYyxDQUFDLE9BQU8sQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFDcEU7WUFDQSxXQUFXLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDbkIsV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDO1NBQ3BCO2FBQU07WUFDTCxhQUFhLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ3ZDLGFBQWEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7U0FDeEM7S0FDRjtJQUVELE9BQU8sRUFBRSxXQUFXLEVBQUUsYUFBYSxFQUFFLFdBQVcsRUFBRSxhQUFhLEVBQUUsQ0FBQztBQUNwRSxDQUFDO0FBRUQsTUFBTSxnQkFBZ0I7SUFJcEIsWUFBb0IsUUFBdUI7UUFBdkIsYUFBUSxHQUFSLFFBQVEsQ0FBZTtRQUhuQyxVQUFLLEdBQUcsQ0FBQyxDQUFDO1FBQ1YsUUFBRyxHQUFHLENBQUMsQ0FBQztJQUU4QixDQUFDO0lBRS9DLElBQUk7UUFDRixJQUFJLElBQUksQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNO1lBQUUsT0FBTyxJQUFJLENBQUM7UUFDbEQsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUNqQyxDQUFDO0lBRUQsSUFBSTtRQUNGLElBQUksSUFBSSxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU07WUFBRSxPQUFPLElBQUksQ0FBQztRQUNsRCxPQUFPLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxJQUFJLENBQUM7SUFDakMsQ0FBQztJQUVELElBQUk7UUFDRixJQUFJLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQzNCLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUVoQixJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLE1BQU0sRUFBRTtZQUN0QyxHQUFHO2dCQUNELElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQzthQUNqQixRQUFRLElBQUksQ0FBQyxLQUFLLEtBQUssU0FBUyxFQUFFO1NBQ3BDO0lBQ0gsQ0FBQztJQUVPLFFBQVE7UUFDZCxJQUFJLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBRXRDLElBQUksS0FBSyxLQUFLLE1BQU0sRUFBRTtZQUNwQixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDZDthQUFNLElBQUksS0FBSyxLQUFLLElBQUksRUFBRTtZQUN6QixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDZDtRQUVELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2ltcGxlTm9kZSwgTm9kZVR5cGUsIFNpbXBsZUVsZW1lbnQgfSBmcm9tICdAc2ltcGxlLWRvbS9pbnRlcmZhY2UnO1xuaW1wb3J0IHsgT3B0aW9uIH0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyByZXBsYWNlSFRNTCwgdG9Jbm5lckhUTUwgfSBmcm9tICcuL2RvbS9zaW1wbGUtdXRpbHMnO1xuaW1wb3J0IHsgdG9rZW5pemUsIEVuZFRhZywgVG9rZW4gfSBmcm9tICdzaW1wbGUtaHRtbC10b2tlbml6ZXInO1xuXG5leHBvcnQgdHlwZSBJbmRpdmlkdWFsU25hcHNob3QgPSAndXAnIHwgJ2Rvd24nIHwgU2ltcGxlTm9kZTtcbmV4cG9ydCB0eXBlIE5vZGVzU25hcHNob3QgPSBJbmRpdmlkdWFsU25hcHNob3RbXTtcblxuZXhwb3J0IGZ1bmN0aW9uIHNuYXBzaG90SXNOb2RlKHNuYXBzaG90OiBJbmRpdmlkdWFsU25hcHNob3QpOiBzbmFwc2hvdCBpcyBTaW1wbGVOb2RlIHtcbiAgcmV0dXJuIHNuYXBzaG90ICE9PSAndXAnICYmIHNuYXBzaG90ICE9PSAnZG93bic7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBlcXVhbFRva2VucyhcbiAgdGVzdEZyYWdtZW50OiBTaW1wbGVFbGVtZW50IHwgc3RyaW5nIHwgbnVsbCxcbiAgdGVzdEhUTUw6IFNpbXBsZUVsZW1lbnQgfCBzdHJpbmcsXG4gIG1lc3NhZ2U6IE9wdGlvbjxzdHJpbmc+ID0gbnVsbFxuKSB7XG4gIGlmICh0ZXN0RnJhZ21lbnQgPT09IG51bGwpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWRseSBwYXNzZWQgbnVsbCB0byBlcXVhbFRva2Vuc2ApO1xuICB9XG5cbiAgbGV0IGZyYWdUb2tlbnMgPSBnZW5lcmF0ZVRva2Vucyh0ZXN0RnJhZ21lbnQpO1xuICBsZXQgaHRtbFRva2VucyA9IGdlbmVyYXRlVG9rZW5zKHRlc3RIVE1MKTtcblxuICAvLyBsZXQgbXNnID0gXCJFeHBlY3RlZDogXCIgKyBodG1sVG9rZW5zLmh0bWwgKyBcIjsgQWN0dWFsOiBcIiArIGZyYWdUb2tlbnMuaHRtbDtcblxuICAvLyBpZiAobWVzc2FnZSkgeyBtc2cgKz0gXCIgKFwiICsgbWVzc2FnZSArIFwiKVwiOyB9XG5cbiAgbGV0IGVxdWl2ID0gUVVuaXQuZXF1aXYoZnJhZ1Rva2Vucy50b2tlbnMsIGh0bWxUb2tlbnMudG9rZW5zKTtcblxuICBpZiAoZXF1aXYgJiYgZnJhZ1Rva2Vucy5odG1sICE9PSBodG1sVG9rZW5zLmh0bWwpIHtcbiAgICBRVW5pdC5hc3NlcnQuZGVlcEVxdWFsKFxuICAgICAgZnJhZ1Rva2Vucy50b2tlbnMsXG4gICAgICBodG1sVG9rZW5zLnRva2VucyxcbiAgICAgIG1lc3NhZ2UgfHwgJ2V4cGVjdGVkIHRva2VucyB0byBtYXRjaCdcbiAgICApO1xuICB9IGVsc2Uge1xuICAgIFFVbml0LmFzc2VydC5wdXNoUmVzdWx0KHtcbiAgICAgIHJlc3VsdDogUVVuaXQuZXF1aXYoZnJhZ1Rva2Vucy50b2tlbnMsIGh0bWxUb2tlbnMudG9rZW5zKSxcbiAgICAgIGFjdHVhbDogZnJhZ1Rva2Vucy5odG1sLFxuICAgICAgZXhwZWN0ZWQ6IGh0bWxUb2tlbnMuaHRtbCxcbiAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UgfHwgJ2V4cGVjdGVkIHRva2VucyB0byBtYXRjaCcsXG4gICAgfSk7XG4gIH1cblxuICAvLyBRVW5pdC5hc3NlcnQuZGVlcEVxdWFsKGZyYWdUb2tlbnMudG9rZW5zLCBodG1sVG9rZW5zLnRva2VucywgbXNnKTtcbn1cblxuZnVuY3Rpb24gaXNNYXJrZXIobm9kZTogU2ltcGxlTm9kZSkge1xuICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gTm9kZVR5cGUuQ09NTUVOVF9OT0RFICYmIG5vZGUubm9kZVZhbHVlID09PSAnJykge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgaWYgKG5vZGUubm9kZVR5cGUgPT09IE5vZGVUeXBlLlRFWFRfTk9ERSAmJiBub2RlLm5vZGVWYWx1ZSA9PT0gJycpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHJldHVybiBmYWxzZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlU25hcHNob3QoZWxlbWVudDogU2ltcGxlRWxlbWVudCk6IFNpbXBsZU5vZGVbXSB7XG4gIGxldCBzbmFwc2hvdDogU2ltcGxlTm9kZVtdID0gW107XG4gIGxldCBub2RlOiBPcHRpb248U2ltcGxlTm9kZT4gPSBlbGVtZW50LmZpcnN0Q2hpbGQ7XG5cbiAgd2hpbGUgKG5vZGUpIHtcbiAgICBpZiAoIWlzTWFya2VyKG5vZGUpKSB7XG4gICAgICBzbmFwc2hvdC5wdXNoKG5vZGUpO1xuICAgIH1cbiAgICBub2RlID0gbm9kZS5uZXh0U2libGluZztcbiAgfVxuXG4gIHJldHVybiBzbmFwc2hvdDtcbn1cblxuZnVuY3Rpb24gZ2VuZXJhdGVUb2tlbnMoZGl2T3JIVE1MOiBTaW1wbGVFbGVtZW50IHwgc3RyaW5nKTogeyB0b2tlbnM6IFRva2VuW107IGh0bWw6IHN0cmluZyB9IHtcbiAgbGV0IGRpdjogU2ltcGxlRWxlbWVudDtcbiAgaWYgKHR5cGVvZiBkaXZPckhUTUwgPT09ICdzdHJpbmcnKSB7XG4gICAgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykgYXMgU2ltcGxlRWxlbWVudDtcbiAgICByZXBsYWNlSFRNTChkaXYsIGRpdk9ySFRNTCk7XG4gIH0gZWxzZSB7XG4gICAgZGl2ID0gZGl2T3JIVE1MO1xuICB9XG5cbiAgbGV0IHRva2VucyA9IHRva2VuaXplKHRvSW5uZXJIVE1MKGRpdiksIHt9KTtcblxuICB0b2tlbnMgPSB0b2tlbnMucmVkdWNlKCh0b2tlbnMsIHRva2VuKSA9PiB7XG4gICAgaWYgKHRva2VuLnR5cGUgPT09ICdTdGFydFRhZycpIHtcbiAgICAgIGlmICh0b2tlbi5hdHRyaWJ1dGVzKSB7XG4gICAgICAgIHRva2VuLmF0dHJpYnV0ZXMuc29ydCgoYSwgYikgPT4ge1xuICAgICAgICAgIGlmIChhWzBdID4gYlswXSkge1xuICAgICAgICAgICAgcmV0dXJuIDE7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChhWzBdIDwgYlswXSkge1xuICAgICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0b2tlbi5zZWxmQ2xvc2luZykge1xuICAgICAgICB0b2tlbi5zZWxmQ2xvc2luZyA9IGZhbHNlO1xuICAgICAgICB0b2tlbnMucHVzaCh0b2tlbik7XG4gICAgICAgIHRva2Vucy5wdXNoKHsgdHlwZTogJ0VuZFRhZycsIHRhZ05hbWU6IHRva2VuLnRhZ05hbWUgfSBhcyBFbmRUYWcpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdG9rZW5zLnB1c2godG9rZW4pO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0b2tlbnMucHVzaCh0b2tlbik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRva2VucztcbiAgfSwgbmV3IEFycmF5PFRva2VuPigpKTtcblxuICByZXR1cm4geyB0b2tlbnMsIGh0bWw6IHRvSW5uZXJIVE1MKGRpdikgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGVxdWFsU25hcHNob3RzKGE6IFNpbXBsZU5vZGVbXSwgYjogU2ltcGxlTm9kZVtdKSB7XG4gIFFVbml0LmFzc2VydC5zdHJpY3RFcXVhbChhLmxlbmd0aCwgYi5sZW5ndGgsICdTYW1lIG51bWJlciBvZiBub2RlcycpO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGIubGVuZ3RoOyBpKyspIHtcbiAgICBRVW5pdC5hc3NlcnQuc3RyaWN0RXF1YWwoYVtpXSwgYltpXSwgJ05vZGVzIGFyZSB0aGUgc2FtZScpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1NlcnZlck1hcmtlcihub2RlOiBTaW1wbGVOb2RlKSB7XG4gIHJldHVybiBub2RlLm5vZGVUeXBlID09PSBOb2RlVHlwZS5DT01NRU5UX05PREUgJiYgbm9kZS5ub2RlVmFsdWUhLmNoYXJBdCgwKSA9PT0gJyUnO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gbm9ybWFsaXplU25hcHNob3QoXG4gIG9sZFNuYXBzaG90OiBOb2Rlc1NuYXBzaG90LFxuICBuZXdTbmFwc2hvdDogTm9kZXNTbmFwc2hvdCxcbiAgZXhjZXB0OiBBcnJheTxTaW1wbGVOb2RlPlxuKSB7XG4gIGxldCBvbGRJdGVyYXRvciA9IG5ldyBTbmFwc2hvdEl0ZXJhdG9yKG9sZFNuYXBzaG90KTtcbiAgbGV0IG5ld0l0ZXJhdG9yID0gbmV3IFNuYXBzaG90SXRlcmF0b3IobmV3U25hcHNob3QpO1xuXG4gIGxldCBub3JtYWxpemVkT2xkID0gW107XG4gIGxldCBub3JtYWxpemVkTmV3ID0gW107XG5cbiAgd2hpbGUgKHRydWUpIHtcbiAgICBsZXQgbmV4dE9sZCA9IG9sZEl0ZXJhdG9yLnBlZWsoKTtcbiAgICBsZXQgbmV4dE5ldyA9IG5ld0l0ZXJhdG9yLnBlZWsoKTtcblxuICAgIGlmIChuZXh0T2xkID09PSBudWxsICYmIG5ld0l0ZXJhdG9yLnBlZWsoKSA9PT0gbnVsbCkgYnJlYWs7XG5cbiAgICBpZiAoXG4gICAgICAobmV4dE9sZCAmJiBzbmFwc2hvdElzTm9kZShuZXh0T2xkKSAmJiBleGNlcHQuaW5kZXhPZihuZXh0T2xkKSA+IC0xKSB8fFxuICAgICAgKG5leHROZXcgJiYgc25hcHNob3RJc05vZGUobmV4dE5ldykgJiYgZXhjZXB0LmluZGV4T2YobmV4dE5ldykgPiAtMSlcbiAgICApIHtcbiAgICAgIG9sZEl0ZXJhdG9yLnNraXAoKTtcbiAgICAgIG5ld0l0ZXJhdG9yLnNraXAoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbm9ybWFsaXplZE9sZC5wdXNoKG9sZEl0ZXJhdG9yLm5leHQoKSk7XG4gICAgICBub3JtYWxpemVkTmV3LnB1c2gobmV3SXRlcmF0b3IubmV4dCgpKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4geyBvbGRTbmFwc2hvdDogbm9ybWFsaXplZE9sZCwgbmV3U25hcHNob3Q6IG5vcm1hbGl6ZWROZXcgfTtcbn1cblxuY2xhc3MgU25hcHNob3RJdGVyYXRvciB7XG4gIHByaXZhdGUgZGVwdGggPSAwO1xuICBwcml2YXRlIHBvcyA9IDA7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBzbmFwc2hvdDogTm9kZXNTbmFwc2hvdCkge31cblxuICBwZWVrKCk6IE9wdGlvbjxJbmRpdmlkdWFsU25hcHNob3Q+IHtcbiAgICBpZiAodGhpcy5wb3MgPj0gdGhpcy5zbmFwc2hvdC5sZW5ndGgpIHJldHVybiBudWxsO1xuICAgIHJldHVybiB0aGlzLnNuYXBzaG90W3RoaXMucG9zXTtcbiAgfVxuXG4gIG5leHQoKTogT3B0aW9uPEluZGl2aWR1YWxTbmFwc2hvdD4ge1xuICAgIGlmICh0aGlzLnBvcyA+PSB0aGlzLnNuYXBzaG90Lmxlbmd0aCkgcmV0dXJuIG51bGw7XG4gICAgcmV0dXJuIHRoaXMubmV4dE5vZGUoKSB8fCBudWxsO1xuICB9XG5cbiAgc2tpcCgpOiB2b2lkIHtcbiAgICBsZXQgc2tpcFVudGlsID0gdGhpcy5kZXB0aDtcbiAgICB0aGlzLm5leHROb2RlKCk7XG5cbiAgICBpZiAodGhpcy5zbmFwc2hvdFt0aGlzLnBvc10gPT09ICdkb3duJykge1xuICAgICAgZG8ge1xuICAgICAgICB0aGlzLm5leHROb2RlKCk7XG4gICAgICB9IHdoaWxlICh0aGlzLmRlcHRoICE9PSBza2lwVW50aWwpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbmV4dE5vZGUoKTogSW5kaXZpZHVhbFNuYXBzaG90IHtcbiAgICBsZXQgdG9rZW4gPSB0aGlzLnNuYXBzaG90W3RoaXMucG9zKytdO1xuXG4gICAgaWYgKHRva2VuID09PSAnZG93bicpIHtcbiAgICAgIHRoaXMuZGVwdGgrKztcbiAgICB9IGVsc2UgaWYgKHRva2VuID09PSAndXAnKSB7XG4gICAgICB0aGlzLmRlcHRoLS07XG4gICAgfVxuXG4gICAgcmV0dXJuIHRva2VuO1xuICB9XG59XG4iXX0=
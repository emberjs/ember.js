import { bump, isConst } from '@glimmer/reference';
import { clearElement, dict, expect, assign } from '@glimmer/util';
import { CURLY_TEST_COMPONENT, GLIMMER_TEST_COMPONENT, } from './components';
import { assertElementShape, assertEmberishElement } from './dom/assertions';
import { normalizeInnerHTML } from './dom/normalize';
import { assertElement, toInnerHTML } from './dom/simple-utils';
import { equalTokens, isServerMarker, normalizeSnapshot } from './snapshot';
export class Count {
    constructor() {
        this.expected = dict();
        this.actual = dict();
    }
    expect(name, count = 1) {
        this.expected[name] = count;
        this.actual[name] = (this.actual[name] || 0) + 1;
    }
    assert() {
        QUnit.assert.deepEqual(this.actual, this.expected, 'TODO');
    }
}
export class RenderTest {
    constructor(delegate) {
        this.delegate = delegate;
        this.assert = QUnit.assert;
        this.context = dict();
        this.renderResult = null;
        this.helpers = dict();
        this.snapshot = [];
        this.count = new Count();
        this.element = delegate.getInitialElement();
    }
    registerHelper(name, helper) {
        this.delegate.registerHelper(name, helper);
    }
    registerModifier(name, ModifierClass) {
        this.delegate.registerModifier(name, ModifierClass);
    }
    registerComponent(type, name, layout, Class) {
        this.delegate.registerComponent(type, this.testType, name, layout, Class);
    }
    buildComponent(blueprint) {
        let invocation = '';
        switch (this.testType) {
            case 'Glimmer':
                invocation = this.buildGlimmerComponent(blueprint);
                break;
            case 'Curly':
                invocation = this.buildCurlyComponent(blueprint);
                break;
            case 'Dynamic':
                invocation = this.buildDynamicComponent(blueprint);
                break;
            case 'Basic':
                invocation = this.buildBasicComponent(blueprint);
                break;
            case 'Fragment':
                invocation = this.buildFragmentComponent(blueprint);
                break;
            default:
                throw new Error(`Invalid test type ${this.testType}`);
        }
        return invocation;
    }
    buildArgs(args) {
        let { testType } = this;
        let sigil = '';
        let needsCurlies = false;
        if (testType === 'Glimmer' || testType === 'Basic' || testType === 'Fragment') {
            sigil = '@';
            needsCurlies = true;
        }
        return `${Object.keys(args)
            .map(arg => {
            let rightSide;
            let value = args[arg];
            if (needsCurlies) {
                let isString = value && (value[0] === "'" || value[0] === '"');
                if (isString) {
                    rightSide = `${value}`;
                }
                else {
                    rightSide = `{{${value}}}`;
                }
            }
            else {
                rightSide = `${value}`;
            }
            return `${sigil}${arg}=${rightSide}`;
        })
            .join(' ')}`;
    }
    buildBlockParams(blockParams) {
        return `${blockParams.length > 0 ? ` as |${blockParams.join(' ')}|` : ''}`;
    }
    buildElse(elseBlock) {
        return `${elseBlock ? `{{else}}${elseBlock}` : ''}`;
    }
    buildAttributes(attrs = {}) {
        return Object.keys(attrs)
            .map(attr => `${attr}=${attrs[attr]}`)
            .join(' ');
    }
    buildAngleBracketComponent(blueprint) {
        let { args = {}, attributes = {}, template, name = GLIMMER_TEST_COMPONENT, blockParams = [], } = blueprint;
        let invocation = [];
        invocation.push(`<${name}`);
        let componetArgs = this.buildArgs(args);
        if (componetArgs !== '') {
            invocation.push(componetArgs);
        }
        let attrs = this.buildAttributes(attributes);
        if (attrs !== '') {
            invocation.push(attrs);
        }
        let open = invocation.join(' ');
        invocation = [open];
        if (template) {
            let block = [];
            let params = this.buildBlockParams(blockParams);
            if (params !== '') {
                block.push(params);
            }
            block.push(`>`);
            block.push(template);
            block.push(`</${name}>`);
            invocation.push(block.join(''));
        }
        else {
            invocation.push(' ');
            invocation.push(`/>`);
        }
        return invocation.join('');
    }
    buildGlimmerComponent(blueprint) {
        let { tag = 'div', layout, name = GLIMMER_TEST_COMPONENT } = blueprint;
        let invocation = this.buildAngleBracketComponent(blueprint);
        let layoutAttrs = this.buildAttributes(blueprint.layoutAttributes);
        this.assert.ok(true, `generated glimmer layout as ${`<${tag} ${layoutAttrs} ...attributes>${layout}</${tag}>`}`);
        this.delegate.registerComponent('Glimmer', this.testType, name, `<${tag} ${layoutAttrs} ...attributes>${layout}</${tag}>`);
        this.assert.ok(true, `generated glimmer invocation as ${invocation}`);
        return invocation;
    }
    buildCurlyBlockTemplate(name, template, blockParams, elseBlock) {
        let block = [];
        block.push(this.buildBlockParams(blockParams));
        block.push('}}');
        block.push(template);
        block.push(this.buildElse(elseBlock));
        block.push(`{{/${name}}}`);
        return block.join('');
    }
    buildCurlyComponent(blueprint) {
        let { args = {}, layout, template, attributes, else: elseBlock, name = CURLY_TEST_COMPONENT, blockParams = [], } = blueprint;
        if (attributes) {
            throw new Error('Cannot pass attributes to curly components');
        }
        let invocation = [];
        if (template) {
            invocation.push(`{{#${name}`);
        }
        else {
            invocation.push(`{{${name}`);
        }
        let componentArgs = this.buildArgs(args);
        if (componentArgs !== '') {
            invocation.push(' ');
            invocation.push(componentArgs);
        }
        if (template) {
            invocation.push(this.buildCurlyBlockTemplate(name, template, blockParams, elseBlock));
        }
        else {
            invocation.push('}}');
        }
        this.assert.ok(true, `generated curly layout as ${layout}`);
        this.delegate.registerComponent('Curly', this.testType, name, layout);
        invocation = invocation.join('');
        this.assert.ok(true, `generated curly invocation as ${invocation}`);
        return invocation;
    }
    buildFragmentComponent(blueprint) {
        let { layout, name = GLIMMER_TEST_COMPONENT } = blueprint;
        let invocation = this.buildAngleBracketComponent(blueprint);
        this.assert.ok(true, `generated fragment layout as ${layout}`);
        this.delegate.registerComponent('Basic', this.testType, name, `${layout}`);
        this.assert.ok(true, `generated fragment invocation as ${invocation}`);
        return invocation;
    }
    buildBasicComponent(blueprint) {
        let { tag = 'div', layout, name = GLIMMER_TEST_COMPONENT } = blueprint;
        let invocation = this.buildAngleBracketComponent(blueprint);
        this.assert.ok(true, `generated basic layout as ${layout}`);
        this.delegate.registerComponent('Basic', this.testType, name, `<${tag} ...attributes>${layout}</${tag}>`);
        this.assert.ok(true, `generated basic invocation as ${invocation}`);
        return invocation;
    }
    buildDynamicComponent(blueprint) {
        let { args = {}, layout, template, attributes, else: elseBlock, name = GLIMMER_TEST_COMPONENT, blockParams = [], } = blueprint;
        if (attributes) {
            throw new Error('Cannot pass attributes to curly components');
        }
        let invocation = [];
        if (template) {
            invocation.push('{{#component componentName');
        }
        else {
            invocation.push('{{component componentName');
        }
        let componentArgs = this.buildArgs(args);
        if (componentArgs !== '') {
            invocation.push(' ');
            invocation.push(componentArgs);
        }
        if (template) {
            invocation.push(this.buildCurlyBlockTemplate('component', template, blockParams, elseBlock));
        }
        else {
            invocation.push('}}');
        }
        this.assert.ok(true, `generated dynamic layout as ${layout}`);
        this.delegate.registerComponent('Curly', this.testType, name, layout);
        invocation = invocation.join('');
        this.assert.ok(true, `generated dynamic invocation as ${invocation}`);
        return invocation;
    }
    shouldBeVoid(tagName) {
        clearElement(this.element);
        let html = '<' + tagName + " data-foo='bar'><p>hello</p>";
        this.delegate.renderTemplate(html, this.context, this.element, () => this.takeSnapshot());
        let tag = '<' + tagName + ' data-foo="bar">';
        let closing = '</' + tagName + '>';
        let extra = '<p>hello</p>';
        html = normalizeInnerHTML(toInnerHTML(this.element));
        QUnit.assert.pushResult({
            result: html === tag + extra || html === tag + closing + extra,
            actual: html,
            expected: tag + closing + extra,
            message: tagName + ' should be a void element',
        });
    }
    render(template, properties = {}) {
        QUnit.assert.ok(true, `Rendering ${template} with ${JSON.stringify(properties)}`);
        if (typeof template === 'object') {
            let blueprint = template;
            template = this.buildComponent(blueprint);
            if (this.testType === 'Dynamic' && properties['componentName'] === undefined) {
                properties['componentName'] = blueprint.name || GLIMMER_TEST_COMPONENT;
            }
        }
        this.setProperties(properties);
        this.renderResult = this.delegate.renderTemplate(template, this.context, this.element, () => this.takeSnapshot());
    }
    rerender(properties = {}) {
        QUnit.assert.ok(true, `rerender ${JSON.stringify(properties)}`);
        this.setProperties(properties);
        let self = this.delegate.getSelf(this.context);
        if (!isConst(self)) {
            self.forceUpdate(this.context);
        }
        let result = expect(this.renderResult, 'the test should call render() before rerender()');
        result.env.begin();
        result.rerender();
        result.env.commit();
    }
    set(key, value) {
        this.context[key] = value;
    }
    setProperties(properties) {
        assign(this.context, properties);
        bump();
    }
    takeSnapshot() {
        let snapshot = (this.snapshot = []);
        let node = this.element.firstChild;
        let upped = false;
        while (node && node !== this.element) {
            if (upped) {
                if (node.nextSibling) {
                    node = node.nextSibling;
                    upped = false;
                }
                else {
                    snapshot.push('up');
                    node = node.parentNode;
                }
            }
            else {
                if (!isServerMarker(node))
                    snapshot.push(node);
                if (node.firstChild) {
                    snapshot.push('down');
                    node = node.firstChild;
                }
                else if (node.nextSibling) {
                    node = node.nextSibling;
                }
                else {
                    snapshot.push('up');
                    node = node.parentNode;
                    upped = true;
                }
            }
        }
        return snapshot;
    }
    assertStableRerender() {
        this.takeSnapshot();
        this.runTask(() => this.rerender());
        this.assertStableNodes();
    }
    assertHTML(html, message) {
        equalTokens(this.element, html, message ? `${html} (${message})` : html);
        this.takeSnapshot();
    }
    assertComponent(content, attrs = {}) {
        let element = assertElement(this.element.firstChild);
        switch (this.testType) {
            case 'Glimmer':
                assertElementShape(element, 'div', attrs, content);
                break;
            default:
                assertEmberishElement(element, 'div', attrs, content);
        }
        this.takeSnapshot();
    }
    runTask(callback) {
        return callback();
    }
    assertStableNodes({ except: _except } = {
        except: [],
    }) {
        let except;
        if (Array.isArray(_except)) {
            except = uniq(_except);
        }
        else {
            except = [_except];
        }
        let { oldSnapshot, newSnapshot } = normalizeSnapshot(this.snapshot, this.takeSnapshot(), except);
        this.assert.deepEqual(oldSnapshot, newSnapshot, 'DOM nodes are stable');
    }
}
function uniq(arr) {
    return arr.reduce((accum, val) => {
        if (accum.indexOf(val) === -1)
            accum.push(val);
        return accum;
    }, []);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyLXRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9saWIvcmVuZGVyLXRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQXNCLE1BQU0sb0JBQW9CLENBQUM7QUFDdkUsT0FBTyxFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVuRSxPQUFPLEVBSUwsb0JBQW9CLEVBQ3BCLHNCQUFzQixHQUN2QixNQUFNLGNBQWMsQ0FBQztBQUN0QixPQUFPLEVBQUUsa0JBQWtCLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUM3RSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsYUFBYSxFQUFFLFdBQVcsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBSWhFLE9BQU8sRUFBRSxXQUFXLEVBQUUsY0FBYyxFQUFpQixpQkFBaUIsRUFBRSxNQUFNLFlBQVksQ0FBQztBQU8zRixNQUFNLE9BQU8sS0FBSztJQUFsQjtRQUNVLGFBQVEsR0FBRyxJQUFJLEVBQVUsQ0FBQztRQUMxQixXQUFNLEdBQUcsSUFBSSxFQUFVLENBQUM7SUFVbEMsQ0FBQztJQVJDLE1BQU0sQ0FBQyxJQUFZLEVBQUUsS0FBSyxHQUFHLENBQUM7UUFDNUIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUM7UUFDNUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ25ELENBQUM7SUFFRCxNQUFNO1FBQ0osS0FBSyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsUUFB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Q25CLE1BQU0sQ0FDUCxDQUFDO1FBRUYsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLFdBQVcsRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO0lBQzFFLENBQUM7Q0FDRjtBQUVELFNBQVMsSUFBSSxDQUFDLEdBQVU7SUFDdEIsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRSxFQUFFO1FBQy9CLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7WUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQy9DLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0FBQ1QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERpY3QsIE1heWJlLCBPcHRpb24sIFJlbmRlclJlc3VsdCB9IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgYnVtcCwgaXNDb25zdCwgVXBkYXRhYmxlUmVmZXJlbmNlIH0gZnJvbSAnQGdsaW1tZXIvcmVmZXJlbmNlJztcbmltcG9ydCB7IGNsZWFyRWxlbWVudCwgZGljdCwgZXhwZWN0LCBhc3NpZ24gfSBmcm9tICdAZ2xpbW1lci91dGlsJztcbmltcG9ydCB7IFNpbXBsZUVsZW1lbnQsIFNpbXBsZU5vZGUgfSBmcm9tICdAc2ltcGxlLWRvbS9pbnRlcmZhY2UnO1xuaW1wb3J0IHtcbiAgQ29tcG9uZW50Qmx1ZXByaW50LFxuICBDb21wb25lbnRLaW5kLFxuICBDb21wb25lbnRUeXBlcyxcbiAgQ1VSTFlfVEVTVF9DT01QT05FTlQsXG4gIEdMSU1NRVJfVEVTVF9DT01QT05FTlQsXG59IGZyb20gJy4vY29tcG9uZW50cyc7XG5pbXBvcnQgeyBhc3NlcnRFbGVtZW50U2hhcGUsIGFzc2VydEVtYmVyaXNoRWxlbWVudCB9IGZyb20gJy4vZG9tL2Fzc2VydGlvbnMnO1xuaW1wb3J0IHsgbm9ybWFsaXplSW5uZXJIVE1MIH0gZnJvbSAnLi9kb20vbm9ybWFsaXplJztcbmltcG9ydCB7IGFzc2VydEVsZW1lbnQsIHRvSW5uZXJIVE1MIH0gZnJvbSAnLi9kb20vc2ltcGxlLXV0aWxzJztcbmltcG9ydCB7IFVzZXJIZWxwZXIgfSBmcm9tICcuL2hlbHBlcnMnO1xuaW1wb3J0IHsgVGVzdE1vZGlmaWVyQ29uc3RydWN0b3IgfSBmcm9tICcuL21vZGlmaWVycyc7XG5pbXBvcnQgUmVuZGVyRGVsZWdhdGUgZnJvbSAnLi9yZW5kZXItZGVsZWdhdGUnO1xuaW1wb3J0IHsgZXF1YWxUb2tlbnMsIGlzU2VydmVyTWFya2VyLCBOb2Rlc1NuYXBzaG90LCBub3JtYWxpemVTbmFwc2hvdCB9IGZyb20gJy4vc25hcHNob3QnO1xuXG5leHBvcnQgaW50ZXJmYWNlIElSZW5kZXJUZXN0IHtcbiAgcmVhZG9ubHkgY291bnQ6IENvdW50O1xuICB0ZXN0VHlwZTogQ29tcG9uZW50S2luZDtcbn1cblxuZXhwb3J0IGNsYXNzIENvdW50IHtcbiAgcHJpdmF0ZSBleHBlY3RlZCA9IGRpY3Q8bnVtYmVyPigpO1xuICBwcml2YXRlIGFjdHVhbCA9IGRpY3Q8bnVtYmVyPigpO1xuXG4gIGV4cGVjdChuYW1lOiBzdHJpbmcsIGNvdW50ID0gMSkge1xuICAgIHRoaXMuZXhwZWN0ZWRbbmFtZV0gPSBjb3VudDtcbiAgICB0aGlzLmFjdHVhbFtuYW1lXSA9ICh0aGlzLmFjdHVhbFtuYW1lXSB8fCAwKSArIDE7XG4gIH1cblxuICBhc3NlcnQoKSB7XG4gICAgUVVuaXQuYXNzZXJ0LmRlZXBFcXVhbCh0aGlzLmFjdHVhbCwgdGhpcy5leHBlY3RlZCwgJ1RPRE8nKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgUmVuZGVyVGVzdCBpbXBsZW1lbnRzIElSZW5kZXJUZXN0IHtcbiAgdGVzdFR5cGUhOiBDb21wb25lbnRLaW5kO1xuXG4gIHByb3RlY3RlZCBlbGVtZW50OiBTaW1wbGVFbGVtZW50O1xuICBwcm90ZWN0ZWQgYXNzZXJ0ID0gUVVuaXQuYXNzZXJ0O1xuICBwcm90ZWN0ZWQgY29udGV4dDogRGljdCA9IGRpY3QoKTtcbiAgcHJvdGVjdGVkIHJlbmRlclJlc3VsdDogT3B0aW9uPFJlbmRlclJlc3VsdD4gPSBudWxsO1xuICBwcm90ZWN0ZWQgaGVscGVycyA9IGRpY3Q8VXNlckhlbHBlcj4oKTtcbiAgcHJvdGVjdGVkIHNuYXBzaG90OiBOb2Rlc1NuYXBzaG90ID0gW107XG4gIHJlYWRvbmx5IGNvdW50ID0gbmV3IENvdW50KCk7XG5cbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIGRlbGVnYXRlOiBSZW5kZXJEZWxlZ2F0ZSkge1xuICAgIHRoaXMuZWxlbWVudCA9IGRlbGVnYXRlLmdldEluaXRpYWxFbGVtZW50KCk7XG4gIH1cblxuICByZWdpc3RlckhlbHBlcihuYW1lOiBzdHJpbmcsIGhlbHBlcjogVXNlckhlbHBlcikge1xuICAgIHRoaXMuZGVsZWdhdGUucmVnaXN0ZXJIZWxwZXIobmFtZSwgaGVscGVyKTtcbiAgfVxuXG4gIHJlZ2lzdGVyTW9kaWZpZXIobmFtZTogc3RyaW5nLCBNb2RpZmllckNsYXNzOiBUZXN0TW9kaWZpZXJDb25zdHJ1Y3Rvcikge1xuICAgIHRoaXMuZGVsZWdhdGUucmVnaXN0ZXJNb2RpZmllcihuYW1lLCBNb2RpZmllckNsYXNzKTtcbiAgfVxuXG4gIHJlZ2lzdGVyQ29tcG9uZW50PEsgZXh0ZW5kcyBDb21wb25lbnRLaW5kPihcbiAgICB0eXBlOiBLLFxuICAgIG5hbWU6IHN0cmluZyxcbiAgICBsYXlvdXQ6IHN0cmluZyxcbiAgICBDbGFzcz86IENvbXBvbmVudFR5cGVzW0tdXG4gICkge1xuICAgIHRoaXMuZGVsZWdhdGUucmVnaXN0ZXJDb21wb25lbnQodHlwZSwgdGhpcy50ZXN0VHlwZSwgbmFtZSwgbGF5b3V0LCBDbGFzcyk7XG4gIH1cblxuICBidWlsZENvbXBvbmVudChibHVlcHJpbnQ6IENvbXBvbmVudEJsdWVwcmludCk6IHN0cmluZyB7XG4gICAgbGV0IGludm9jYXRpb24gPSAnJztcbiAgICBzd2l0Y2ggKHRoaXMudGVzdFR5cGUpIHtcbiAgICAgIGNhc2UgJ0dsaW1tZXInOlxuICAgICAgICBpbnZvY2F0aW9uID0gdGhpcy5idWlsZEdsaW1tZXJDb21wb25lbnQoYmx1ZXByaW50KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdDdXJseSc6XG4gICAgICAgIGludm9jYXRpb24gPSB0aGlzLmJ1aWxkQ3VybHlDb21wb25lbnQoYmx1ZXByaW50KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdEeW5hbWljJzpcbiAgICAgICAgaW52b2NhdGlvbiA9IHRoaXMuYnVpbGREeW5hbWljQ29tcG9uZW50KGJsdWVwcmludCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnQmFzaWMnOlxuICAgICAgICBpbnZvY2F0aW9uID0gdGhpcy5idWlsZEJhc2ljQ29tcG9uZW50KGJsdWVwcmludCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnRnJhZ21lbnQnOlxuICAgICAgICBpbnZvY2F0aW9uID0gdGhpcy5idWlsZEZyYWdtZW50Q29tcG9uZW50KGJsdWVwcmludCk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgdGVzdCB0eXBlICR7dGhpcy50ZXN0VHlwZX1gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gaW52b2NhdGlvbjtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRBcmdzKGFyZ3M6IERpY3QpOiBzdHJpbmcge1xuICAgIGxldCB7IHRlc3RUeXBlIH0gPSB0aGlzO1xuICAgIGxldCBzaWdpbCA9ICcnO1xuICAgIGxldCBuZWVkc0N1cmxpZXMgPSBmYWxzZTtcblxuICAgIGlmICh0ZXN0VHlwZSA9PT0gJ0dsaW1tZXInIHx8IHRlc3RUeXBlID09PSAnQmFzaWMnIHx8IHRlc3RUeXBlID09PSAnRnJhZ21lbnQnKSB7XG4gICAgICBzaWdpbCA9ICdAJztcbiAgICAgIG5lZWRzQ3VybGllcyA9IHRydWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGAke09iamVjdC5rZXlzKGFyZ3MpXG4gICAgICAubWFwKGFyZyA9PiB7XG4gICAgICAgIGxldCByaWdodFNpZGU6IHN0cmluZztcblxuICAgICAgICBsZXQgdmFsdWUgPSBhcmdzW2FyZ10gYXMgTWF5YmU8c3RyaW5nW10+O1xuICAgICAgICBpZiAobmVlZHNDdXJsaWVzKSB7XG4gICAgICAgICAgbGV0IGlzU3RyaW5nID0gdmFsdWUgJiYgKHZhbHVlWzBdID09PSBcIidcIiB8fCB2YWx1ZVswXSA9PT0gJ1wiJyk7XG4gICAgICAgICAgaWYgKGlzU3RyaW5nKSB7XG4gICAgICAgICAgICByaWdodFNpZGUgPSBgJHt2YWx1ZX1gO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByaWdodFNpZGUgPSBge3ske3ZhbHVlfX19YDtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmlnaHRTaWRlID0gYCR7dmFsdWV9YDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBgJHtzaWdpbH0ke2FyZ309JHtyaWdodFNpZGV9YDtcbiAgICAgIH0pXG4gICAgICAuam9pbignICcpfWA7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkQmxvY2tQYXJhbXMoYmxvY2tQYXJhbXM6IHN0cmluZ1tdKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYCR7YmxvY2tQYXJhbXMubGVuZ3RoID4gMCA/IGAgYXMgfCR7YmxvY2tQYXJhbXMuam9pbignICcpfXxgIDogJyd9YDtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRFbHNlKGVsc2VCbG9jazogc3RyaW5nIHwgdW5kZWZpbmVkKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYCR7ZWxzZUJsb2NrID8gYHt7ZWxzZX19JHtlbHNlQmxvY2t9YCA6ICcnfWA7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkQXR0cmlidXRlcyhhdHRyczogRGljdCA9IHt9KTogc3RyaW5nIHtcbiAgICByZXR1cm4gT2JqZWN0LmtleXMoYXR0cnMpXG4gICAgICAubWFwKGF0dHIgPT4gYCR7YXR0cn09JHthdHRyc1thdHRyXX1gKVxuICAgICAgLmpvaW4oJyAnKTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRBbmdsZUJyYWNrZXRDb21wb25lbnQoYmx1ZXByaW50OiBDb21wb25lbnRCbHVlcHJpbnQpOiBzdHJpbmcge1xuICAgIGxldCB7XG4gICAgICBhcmdzID0ge30sXG4gICAgICBhdHRyaWJ1dGVzID0ge30sXG4gICAgICB0ZW1wbGF0ZSxcbiAgICAgIG5hbWUgPSBHTElNTUVSX1RFU1RfQ09NUE9ORU5ULFxuICAgICAgYmxvY2tQYXJhbXMgPSBbXSxcbiAgICB9ID0gYmx1ZXByaW50O1xuXG4gICAgbGV0IGludm9jYXRpb246IHN0cmluZyB8IHN0cmluZ1tdID0gW107XG5cbiAgICBpbnZvY2F0aW9uLnB1c2goYDwke25hbWV9YCk7XG5cbiAgICBsZXQgY29tcG9uZXRBcmdzID0gdGhpcy5idWlsZEFyZ3MoYXJncyk7XG5cbiAgICBpZiAoY29tcG9uZXRBcmdzICE9PSAnJykge1xuICAgICAgaW52b2NhdGlvbi5wdXNoKGNvbXBvbmV0QXJncyk7XG4gICAgfVxuXG4gICAgbGV0IGF0dHJzID0gdGhpcy5idWlsZEF0dHJpYnV0ZXMoYXR0cmlidXRlcyk7XG4gICAgaWYgKGF0dHJzICE9PSAnJykge1xuICAgICAgaW52b2NhdGlvbi5wdXNoKGF0dHJzKTtcbiAgICB9XG5cbiAgICBsZXQgb3BlbiA9IGludm9jYXRpb24uam9pbignICcpO1xuICAgIGludm9jYXRpb24gPSBbb3Blbl07XG5cbiAgICBpZiAodGVtcGxhdGUpIHtcbiAgICAgIGxldCBibG9jazogc3RyaW5nIHwgc3RyaW5nW10gPSBbXTtcbiAgICAgIGxldCBwYXJhbXMgPSB0aGlzLmJ1aWxkQmxvY2tQYXJhbXMoYmxvY2tQYXJhbXMpO1xuICAgICAgaWYgKHBhcmFtcyAhPT0gJycpIHtcbiAgICAgICAgYmxvY2sucHVzaChwYXJhbXMpO1xuICAgICAgfVxuICAgICAgYmxvY2sucHVzaChgPmApO1xuICAgICAgYmxvY2sucHVzaCh0ZW1wbGF0ZSk7XG4gICAgICBibG9jay5wdXNoKGA8LyR7bmFtZX0+YCk7XG4gICAgICBpbnZvY2F0aW9uLnB1c2goYmxvY2suam9pbignJykpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpbnZvY2F0aW9uLnB1c2goJyAnKTtcbiAgICAgIGludm9jYXRpb24ucHVzaChgLz5gKTtcbiAgICB9XG5cbiAgICByZXR1cm4gaW52b2NhdGlvbi5qb2luKCcnKTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRHbGltbWVyQ29tcG9uZW50KGJsdWVwcmludDogQ29tcG9uZW50Qmx1ZXByaW50KTogc3RyaW5nIHtcbiAgICBsZXQgeyB0YWcgPSAnZGl2JywgbGF5b3V0LCBuYW1lID0gR0xJTU1FUl9URVNUX0NPTVBPTkVOVCB9ID0gYmx1ZXByaW50O1xuICAgIGxldCBpbnZvY2F0aW9uID0gdGhpcy5idWlsZEFuZ2xlQnJhY2tldENvbXBvbmVudChibHVlcHJpbnQpO1xuICAgIGxldCBsYXlvdXRBdHRycyA9IHRoaXMuYnVpbGRBdHRyaWJ1dGVzKGJsdWVwcmludC5sYXlvdXRBdHRyaWJ1dGVzKTtcbiAgICB0aGlzLmFzc2VydC5vayhcbiAgICAgIHRydWUsXG4gICAgICBgZ2VuZXJhdGVkIGdsaW1tZXIgbGF5b3V0IGFzICR7YDwke3RhZ30gJHtsYXlvdXRBdHRyc30gLi4uYXR0cmlidXRlcz4ke2xheW91dH08LyR7dGFnfT5gfWBcbiAgICApO1xuICAgIHRoaXMuZGVsZWdhdGUucmVnaXN0ZXJDb21wb25lbnQoXG4gICAgICAnR2xpbW1lcicsXG4gICAgICB0aGlzLnRlc3RUeXBlLFxuICAgICAgbmFtZSxcbiAgICAgIGA8JHt0YWd9ICR7bGF5b3V0QXR0cnN9IC4uLmF0dHJpYnV0ZXM+JHtsYXlvdXR9PC8ke3RhZ30+YFxuICAgICk7XG4gICAgdGhpcy5hc3NlcnQub2sodHJ1ZSwgYGdlbmVyYXRlZCBnbGltbWVyIGludm9jYXRpb24gYXMgJHtpbnZvY2F0aW9ufWApO1xuICAgIHJldHVybiBpbnZvY2F0aW9uO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZEN1cmx5QmxvY2tUZW1wbGF0ZShcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgdGVtcGxhdGU6IHN0cmluZyxcbiAgICBibG9ja1BhcmFtczogc3RyaW5nW10sXG4gICAgZWxzZUJsb2NrPzogc3RyaW5nXG4gICk6IHN0cmluZyB7XG4gICAgbGV0IGJsb2NrOiBzdHJpbmdbXSA9IFtdO1xuICAgIGJsb2NrLnB1c2godGhpcy5idWlsZEJsb2NrUGFyYW1zKGJsb2NrUGFyYW1zKSk7XG4gICAgYmxvY2sucHVzaCgnfX0nKTtcbiAgICBibG9jay5wdXNoKHRlbXBsYXRlKTtcbiAgICBibG9jay5wdXNoKHRoaXMuYnVpbGRFbHNlKGVsc2VCbG9jaykpO1xuICAgIGJsb2NrLnB1c2goYHt7LyR7bmFtZX19fWApO1xuICAgIHJldHVybiBibG9jay5qb2luKCcnKTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRDdXJseUNvbXBvbmVudChibHVlcHJpbnQ6IENvbXBvbmVudEJsdWVwcmludCk6IHN0cmluZyB7XG4gICAgbGV0IHtcbiAgICAgIGFyZ3MgPSB7fSxcbiAgICAgIGxheW91dCxcbiAgICAgIHRlbXBsYXRlLFxuICAgICAgYXR0cmlidXRlcyxcbiAgICAgIGVsc2U6IGVsc2VCbG9jayxcbiAgICAgIG5hbWUgPSBDVVJMWV9URVNUX0NPTVBPTkVOVCxcbiAgICAgIGJsb2NrUGFyYW1zID0gW10sXG4gICAgfSA9IGJsdWVwcmludDtcblxuICAgIGlmIChhdHRyaWJ1dGVzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBwYXNzIGF0dHJpYnV0ZXMgdG8gY3VybHkgY29tcG9uZW50cycpO1xuICAgIH1cblxuICAgIGxldCBpbnZvY2F0aW9uOiBzdHJpbmdbXSB8IHN0cmluZyA9IFtdO1xuXG4gICAgaWYgKHRlbXBsYXRlKSB7XG4gICAgICBpbnZvY2F0aW9uLnB1c2goYHt7IyR7bmFtZX1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaW52b2NhdGlvbi5wdXNoKGB7eyR7bmFtZX1gKTtcbiAgICB9XG5cbiAgICBsZXQgY29tcG9uZW50QXJncyA9IHRoaXMuYnVpbGRBcmdzKGFyZ3MpO1xuXG4gICAgaWYgKGNvbXBvbmVudEFyZ3MgIT09ICcnKSB7XG4gICAgICBpbnZvY2F0aW9uLnB1c2goJyAnKTtcbiAgICAgIGludm9jYXRpb24ucHVzaChjb21wb25lbnRBcmdzKTtcbiAgICB9XG5cbiAgICBpZiAodGVtcGxhdGUpIHtcbiAgICAgIGludm9jYXRpb24ucHVzaCh0aGlzLmJ1aWxkQ3VybHlCbG9ja1RlbXBsYXRlKG5hbWUsIHRlbXBsYXRlLCBibG9ja1BhcmFtcywgZWxzZUJsb2NrKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGludm9jYXRpb24ucHVzaCgnfX0nKTtcbiAgICB9XG4gICAgdGhpcy5hc3NlcnQub2sodHJ1ZSwgYGdlbmVyYXRlZCBjdXJseSBsYXlvdXQgYXMgJHtsYXlvdXR9YCk7XG4gICAgdGhpcy5kZWxlZ2F0ZS5yZWdpc3RlckNvbXBvbmVudCgnQ3VybHknLCB0aGlzLnRlc3RUeXBlLCBuYW1lLCBsYXlvdXQpO1xuICAgIGludm9jYXRpb24gPSBpbnZvY2F0aW9uLmpvaW4oJycpO1xuICAgIHRoaXMuYXNzZXJ0Lm9rKHRydWUsIGBnZW5lcmF0ZWQgY3VybHkgaW52b2NhdGlvbiBhcyAke2ludm9jYXRpb259YCk7XG4gICAgcmV0dXJuIGludm9jYXRpb247XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkRnJhZ21lbnRDb21wb25lbnQoYmx1ZXByaW50OiBDb21wb25lbnRCbHVlcHJpbnQpOiBzdHJpbmcge1xuICAgIGxldCB7IGxheW91dCwgbmFtZSA9IEdMSU1NRVJfVEVTVF9DT01QT05FTlQgfSA9IGJsdWVwcmludDtcbiAgICBsZXQgaW52b2NhdGlvbiA9IHRoaXMuYnVpbGRBbmdsZUJyYWNrZXRDb21wb25lbnQoYmx1ZXByaW50KTtcbiAgICB0aGlzLmFzc2VydC5vayh0cnVlLCBgZ2VuZXJhdGVkIGZyYWdtZW50IGxheW91dCBhcyAke2xheW91dH1gKTtcbiAgICB0aGlzLmRlbGVnYXRlLnJlZ2lzdGVyQ29tcG9uZW50KCdCYXNpYycsIHRoaXMudGVzdFR5cGUsIG5hbWUsIGAke2xheW91dH1gKTtcbiAgICB0aGlzLmFzc2VydC5vayh0cnVlLCBgZ2VuZXJhdGVkIGZyYWdtZW50IGludm9jYXRpb24gYXMgJHtpbnZvY2F0aW9ufWApO1xuICAgIHJldHVybiBpbnZvY2F0aW9uO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZEJhc2ljQ29tcG9uZW50KGJsdWVwcmludDogQ29tcG9uZW50Qmx1ZXByaW50KTogc3RyaW5nIHtcbiAgICBsZXQgeyB0YWcgPSAnZGl2JywgbGF5b3V0LCBuYW1lID0gR0xJTU1FUl9URVNUX0NPTVBPTkVOVCB9ID0gYmx1ZXByaW50O1xuICAgIGxldCBpbnZvY2F0aW9uID0gdGhpcy5idWlsZEFuZ2xlQnJhY2tldENvbXBvbmVudChibHVlcHJpbnQpO1xuICAgIHRoaXMuYXNzZXJ0Lm9rKHRydWUsIGBnZW5lcmF0ZWQgYmFzaWMgbGF5b3V0IGFzICR7bGF5b3V0fWApO1xuICAgIHRoaXMuZGVsZWdhdGUucmVnaXN0ZXJDb21wb25lbnQoXG4gICAgICAnQmFzaWMnLFxuICAgICAgdGhpcy50ZXN0VHlwZSxcbiAgICAgIG5hbWUsXG4gICAgICBgPCR7dGFnfSAuLi5hdHRyaWJ1dGVzPiR7bGF5b3V0fTwvJHt0YWd9PmBcbiAgICApO1xuICAgIHRoaXMuYXNzZXJ0Lm9rKHRydWUsIGBnZW5lcmF0ZWQgYmFzaWMgaW52b2NhdGlvbiBhcyAke2ludm9jYXRpb259YCk7XG4gICAgcmV0dXJuIGludm9jYXRpb247XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkRHluYW1pY0NvbXBvbmVudChibHVlcHJpbnQ6IENvbXBvbmVudEJsdWVwcmludCk6IHN0cmluZyB7XG4gICAgbGV0IHtcbiAgICAgIGFyZ3MgPSB7fSxcbiAgICAgIGxheW91dCxcbiAgICAgIHRlbXBsYXRlLFxuICAgICAgYXR0cmlidXRlcyxcbiAgICAgIGVsc2U6IGVsc2VCbG9jayxcbiAgICAgIG5hbWUgPSBHTElNTUVSX1RFU1RfQ09NUE9ORU5ULFxuICAgICAgYmxvY2tQYXJhbXMgPSBbXSxcbiAgICB9ID0gYmx1ZXByaW50O1xuXG4gICAgaWYgKGF0dHJpYnV0ZXMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHBhc3MgYXR0cmlidXRlcyB0byBjdXJseSBjb21wb25lbnRzJyk7XG4gICAgfVxuXG4gICAgbGV0IGludm9jYXRpb246IHN0cmluZyB8IHN0cmluZ1tdID0gW107XG4gICAgaWYgKHRlbXBsYXRlKSB7XG4gICAgICBpbnZvY2F0aW9uLnB1c2goJ3t7I2NvbXBvbmVudCBjb21wb25lbnROYW1lJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGludm9jYXRpb24ucHVzaCgne3tjb21wb25lbnQgY29tcG9uZW50TmFtZScpO1xuICAgIH1cblxuICAgIGxldCBjb21wb25lbnRBcmdzID0gdGhpcy5idWlsZEFyZ3MoYXJncyk7XG5cbiAgICBpZiAoY29tcG9uZW50QXJncyAhPT0gJycpIHtcbiAgICAgIGludm9jYXRpb24ucHVzaCgnICcpO1xuICAgICAgaW52b2NhdGlvbi5wdXNoKGNvbXBvbmVudEFyZ3MpO1xuICAgIH1cblxuICAgIGlmICh0ZW1wbGF0ZSkge1xuICAgICAgaW52b2NhdGlvbi5wdXNoKHRoaXMuYnVpbGRDdXJseUJsb2NrVGVtcGxhdGUoJ2NvbXBvbmVudCcsIHRlbXBsYXRlLCBibG9ja1BhcmFtcywgZWxzZUJsb2NrKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGludm9jYXRpb24ucHVzaCgnfX0nKTtcbiAgICB9XG5cbiAgICB0aGlzLmFzc2VydC5vayh0cnVlLCBgZ2VuZXJhdGVkIGR5bmFtaWMgbGF5b3V0IGFzICR7bGF5b3V0fWApO1xuICAgIHRoaXMuZGVsZWdhdGUucmVnaXN0ZXJDb21wb25lbnQoJ0N1cmx5JywgdGhpcy50ZXN0VHlwZSwgbmFtZSwgbGF5b3V0KTtcbiAgICBpbnZvY2F0aW9uID0gaW52b2NhdGlvbi5qb2luKCcnKTtcbiAgICB0aGlzLmFzc2VydC5vayh0cnVlLCBgZ2VuZXJhdGVkIGR5bmFtaWMgaW52b2NhdGlvbiBhcyAke2ludm9jYXRpb259YCk7XG5cbiAgICByZXR1cm4gaW52b2NhdGlvbjtcbiAgfVxuXG4gIHNob3VsZEJlVm9pZCh0YWdOYW1lOiBzdHJpbmcpIHtcbiAgICBjbGVhckVsZW1lbnQodGhpcy5lbGVtZW50KTtcbiAgICBsZXQgaHRtbCA9ICc8JyArIHRhZ05hbWUgKyBcIiBkYXRhLWZvbz0nYmFyJz48cD5oZWxsbzwvcD5cIjtcbiAgICB0aGlzLmRlbGVnYXRlLnJlbmRlclRlbXBsYXRlKGh0bWwsIHRoaXMuY29udGV4dCwgdGhpcy5lbGVtZW50LCAoKSA9PiB0aGlzLnRha2VTbmFwc2hvdCgpKTtcblxuICAgIGxldCB0YWcgPSAnPCcgKyB0YWdOYW1lICsgJyBkYXRhLWZvbz1cImJhclwiPic7XG4gICAgbGV0IGNsb3NpbmcgPSAnPC8nICsgdGFnTmFtZSArICc+JztcbiAgICBsZXQgZXh0cmEgPSAnPHA+aGVsbG88L3A+JztcbiAgICBodG1sID0gbm9ybWFsaXplSW5uZXJIVE1MKHRvSW5uZXJIVE1MKHRoaXMuZWxlbWVudCkpO1xuXG4gICAgUVVuaXQuYXNzZXJ0LnB1c2hSZXN1bHQoe1xuICAgICAgcmVzdWx0OiBodG1sID09PSB0YWcgKyBleHRyYSB8fCBodG1sID09PSB0YWcgKyBjbG9zaW5nICsgZXh0cmEsXG4gICAgICBhY3R1YWw6IGh0bWwsXG4gICAgICBleHBlY3RlZDogdGFnICsgY2xvc2luZyArIGV4dHJhLFxuICAgICAgbWVzc2FnZTogdGFnTmFtZSArICcgc2hvdWxkIGJlIGEgdm9pZCBlbGVtZW50JyxcbiAgICB9KTtcbiAgfVxuXG4gIHJlbmRlcih0ZW1wbGF0ZTogc3RyaW5nIHwgQ29tcG9uZW50Qmx1ZXByaW50LCBwcm9wZXJ0aWVzOiBEaWN0PHVua25vd24+ID0ge30pOiB2b2lkIHtcbiAgICBRVW5pdC5hc3NlcnQub2sodHJ1ZSwgYFJlbmRlcmluZyAke3RlbXBsYXRlfSB3aXRoICR7SlNPTi5zdHJpbmdpZnkocHJvcGVydGllcyl9YCk7XG4gICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGxldCBibHVlcHJpbnQgPSB0ZW1wbGF0ZSBhcyBDb21wb25lbnRCbHVlcHJpbnQ7XG4gICAgICB0ZW1wbGF0ZSA9IHRoaXMuYnVpbGRDb21wb25lbnQoYmx1ZXByaW50KTtcblxuICAgICAgaWYgKHRoaXMudGVzdFR5cGUgPT09ICdEeW5hbWljJyAmJiBwcm9wZXJ0aWVzWydjb21wb25lbnROYW1lJ10gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICBwcm9wZXJ0aWVzWydjb21wb25lbnROYW1lJ10gPSBibHVlcHJpbnQubmFtZSB8fCBHTElNTUVSX1RFU1RfQ09NUE9ORU5UO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuc2V0UHJvcGVydGllcyhwcm9wZXJ0aWVzKTtcblxuICAgIHRoaXMucmVuZGVyUmVzdWx0ID0gdGhpcy5kZWxlZ2F0ZS5yZW5kZXJUZW1wbGF0ZSh0ZW1wbGF0ZSwgdGhpcy5jb250ZXh0LCB0aGlzLmVsZW1lbnQsICgpID0+XG4gICAgICB0aGlzLnRha2VTbmFwc2hvdCgpXG4gICAgKTtcbiAgfVxuXG4gIHJlcmVuZGVyKHByb3BlcnRpZXM6IERpY3Q8dW5rbm93bj4gPSB7fSk6IHZvaWQge1xuICAgIFFVbml0LmFzc2VydC5vayh0cnVlLCBgcmVyZW5kZXIgJHtKU09OLnN0cmluZ2lmeShwcm9wZXJ0aWVzKX1gKTtcbiAgICB0aGlzLnNldFByb3BlcnRpZXMocHJvcGVydGllcyk7XG5cbiAgICBsZXQgc2VsZiA9IHRoaXMuZGVsZWdhdGUuZ2V0U2VsZih0aGlzLmNvbnRleHQpO1xuXG4gICAgaWYgKCFpc0NvbnN0KHNlbGYpKSB7XG4gICAgICAoc2VsZiBhcyBVcGRhdGFibGVSZWZlcmVuY2UpLmZvcmNlVXBkYXRlKHRoaXMuY29udGV4dCk7XG4gICAgfVxuXG4gICAgbGV0IHJlc3VsdCA9IGV4cGVjdCh0aGlzLnJlbmRlclJlc3VsdCwgJ3RoZSB0ZXN0IHNob3VsZCBjYWxsIHJlbmRlcigpIGJlZm9yZSByZXJlbmRlcigpJyk7XG5cbiAgICByZXN1bHQuZW52LmJlZ2luKCk7XG4gICAgcmVzdWx0LnJlcmVuZGVyKCk7XG4gICAgcmVzdWx0LmVudi5jb21taXQoKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBzZXQoa2V5OiBzdHJpbmcsIHZhbHVlOiB1bmtub3duKTogdm9pZCB7XG4gICAgdGhpcy5jb250ZXh0W2tleV0gPSB2YWx1ZTtcbiAgfVxuXG4gIHByb3RlY3RlZCBzZXRQcm9wZXJ0aWVzKHByb3BlcnRpZXM6IERpY3Q8dW5rbm93bj4pOiB2b2lkIHtcbiAgICBhc3NpZ24odGhpcy5jb250ZXh0LCBwcm9wZXJ0aWVzKTtcbiAgICBidW1wKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgdGFrZVNuYXBzaG90KCk6IE5vZGVzU25hcHNob3Qge1xuICAgIGxldCBzbmFwc2hvdDogTm9kZXNTbmFwc2hvdCA9ICh0aGlzLnNuYXBzaG90ID0gW10pO1xuXG4gICAgbGV0IG5vZGUgPSB0aGlzLmVsZW1lbnQuZmlyc3RDaGlsZDtcbiAgICBsZXQgdXBwZWQgPSBmYWxzZTtcblxuICAgIHdoaWxlIChub2RlICYmIG5vZGUgIT09IHRoaXMuZWxlbWVudCkge1xuICAgICAgaWYgKHVwcGVkKSB7XG4gICAgICAgIGlmIChub2RlLm5leHRTaWJsaW5nKSB7XG4gICAgICAgICAgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7XG4gICAgICAgICAgdXBwZWQgPSBmYWxzZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBzbmFwc2hvdC5wdXNoKCd1cCcpO1xuICAgICAgICAgIG5vZGUgPSBub2RlLnBhcmVudE5vZGU7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICghaXNTZXJ2ZXJNYXJrZXIobm9kZSkpIHNuYXBzaG90LnB1c2gobm9kZSk7XG5cbiAgICAgICAgaWYgKG5vZGUuZmlyc3RDaGlsZCkge1xuICAgICAgICAgIHNuYXBzaG90LnB1c2goJ2Rvd24nKTtcbiAgICAgICAgICBub2RlID0gbm9kZS5maXJzdENoaWxkO1xuICAgICAgICB9IGVsc2UgaWYgKG5vZGUubmV4dFNpYmxpbmcpIHtcbiAgICAgICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBzbmFwc2hvdC5wdXNoKCd1cCcpO1xuICAgICAgICAgIG5vZGUgPSBub2RlLnBhcmVudE5vZGU7XG4gICAgICAgICAgdXBwZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHNuYXBzaG90O1xuICB9XG5cbiAgcHJvdGVjdGVkIGFzc2VydFN0YWJsZVJlcmVuZGVyKCkge1xuICAgIHRoaXMudGFrZVNuYXBzaG90KCk7XG4gICAgdGhpcy5ydW5UYXNrKCgpID0+IHRoaXMucmVyZW5kZXIoKSk7XG4gICAgdGhpcy5hc3NlcnRTdGFibGVOb2RlcygpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGFzc2VydEhUTUwoaHRtbDogc3RyaW5nLCBtZXNzYWdlPzogc3RyaW5nKSB7XG4gICAgZXF1YWxUb2tlbnModGhpcy5lbGVtZW50LCBodG1sLCBtZXNzYWdlID8gYCR7aHRtbH0gKCR7bWVzc2FnZX0pYCA6IGh0bWwpO1xuICAgIHRoaXMudGFrZVNuYXBzaG90KCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgYXNzZXJ0Q29tcG9uZW50KGNvbnRlbnQ6IHN0cmluZywgYXR0cnM6IE9iamVjdCA9IHt9KSB7XG4gICAgbGV0IGVsZW1lbnQgPSBhc3NlcnRFbGVtZW50KHRoaXMuZWxlbWVudC5maXJzdENoaWxkKTtcblxuICAgIHN3aXRjaCAodGhpcy50ZXN0VHlwZSkge1xuICAgICAgY2FzZSAnR2xpbW1lcic6XG4gICAgICAgIGFzc2VydEVsZW1lbnRTaGFwZShlbGVtZW50LCAnZGl2JywgYXR0cnMsIGNvbnRlbnQpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGFzc2VydEVtYmVyaXNoRWxlbWVudChlbGVtZW50LCAnZGl2JywgYXR0cnMsIGNvbnRlbnQpO1xuICAgIH1cblxuICAgIHRoaXMudGFrZVNuYXBzaG90KCk7XG4gIH1cblxuICBwcml2YXRlIHJ1blRhc2s8VD4oY2FsbGJhY2s6ICgpID0+IFQpOiBUIHtcbiAgICByZXR1cm4gY2FsbGJhY2soKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBhc3NlcnRTdGFibGVOb2RlcyhcbiAgICB7IGV4Y2VwdDogX2V4Y2VwdCB9OiB7IGV4Y2VwdDogU2ltcGxlTm9kZSB8IFNpbXBsZU5vZGVbXSB9ID0ge1xuICAgICAgZXhjZXB0OiBbXSxcbiAgICB9XG4gICkge1xuICAgIGxldCBleGNlcHQ6IEFycmF5PFNpbXBsZU5vZGU+O1xuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkoX2V4Y2VwdCkpIHtcbiAgICAgIGV4Y2VwdCA9IHVuaXEoX2V4Y2VwdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGV4Y2VwdCA9IFtfZXhjZXB0XTtcbiAgICB9XG5cbiAgICBsZXQgeyBvbGRTbmFwc2hvdCwgbmV3U25hcHNob3QgfSA9IG5vcm1hbGl6ZVNuYXBzaG90KFxuICAgICAgdGhpcy5zbmFwc2hvdCxcbiAgICAgIHRoaXMudGFrZVNuYXBzaG90KCksXG4gICAgICBleGNlcHRcbiAgICApO1xuXG4gICAgdGhpcy5hc3NlcnQuZGVlcEVxdWFsKG9sZFNuYXBzaG90LCBuZXdTbmFwc2hvdCwgJ0RPTSBub2RlcyBhcmUgc3RhYmxlJyk7XG4gIH1cbn1cblxuZnVuY3Rpb24gdW5pcShhcnI6IGFueVtdKSB7XG4gIHJldHVybiBhcnIucmVkdWNlKChhY2N1bSwgdmFsKSA9PiB7XG4gICAgaWYgKGFjY3VtLmluZGV4T2YodmFsKSA9PT0gLTEpIGFjY3VtLnB1c2godmFsKTtcbiAgICByZXR1cm4gYWNjdW07XG4gIH0sIFtdKTtcbn1cbiJdfQ==
import { serializeBuilder } from '@glimmer/node';
import { UpdatableReference } from '@glimmer/reference';
import createHTMLDocument from '@simple-dom/document';
import { replaceHTML, toInnerHTML } from '../../dom/simple-utils';
import { JitDelegateContext } from '../jit/delegate';
import { registerComponent, registerHelper, registerModifier } from '../jit/register';
import { renderTemplate } from '../jit/render';
import TestJitRuntimeResolver from '../jit/resolver';
import { debugRehydration } from './builder';
export class RehydrationDelegate {
    constructor() {
        this.self = null;
        this.clientDoc = document;
        this.clientResolver = new TestJitRuntimeResolver();
        this.clientRegistry = this.clientResolver.registry;
        this.clientEnv = JitDelegateContext(this.clientDoc, this.clientResolver, this.clientRegistry);
        this.serverDoc = createHTMLDocument();
        this.serverResolver = new TestJitRuntimeResolver();
        this.serverRegistry = this.serverResolver.registry;
        this.serverEnv = JitDelegateContext(this.serverDoc, this.serverResolver, this.serverRegistry);
    }
    getInitialElement() {
        return this.clientDoc.createElement('div');
    }
    createElement(tagName) {
        return this.clientDoc.createElement(tagName);
    }
    getElementBuilder(env, cursor) {
        if (cursor.element instanceof Node) {
            return debugRehydration(env, cursor);
        }
        return serializeBuilder(env, cursor);
    }
    renderServerSide(template, context, takeSnapshot, element = undefined) {
        element = element || this.serverDoc.createElement('div');
        let cursor = { element, nextSibling: null };
        // Emulate server-side render
        renderTemplate(template, this.serverEnv, this.getSelf(context), this.getElementBuilder(this.serverEnv.runtime.env, cursor));
        takeSnapshot();
        return this.serialize(element);
    }
    getSelf(context) {
        if (!this.self) {
            this.self = new UpdatableReference(context);
        }
        return this.self;
    }
    serialize(element) {
        return toInnerHTML(element);
    }
    renderClientSide(template, context, element) {
        let env = this.clientEnv.runtime.env;
        this.self = null;
        // Client-side rehydration
        let cursor = { element, nextSibling: null };
        let builder = this.getElementBuilder(env, cursor);
        let result = renderTemplate(template, this.clientEnv, this.getSelf(context), builder);
        this.rehydrationStats = {
            clearedNodes: builder['clearedNodes'],
        };
        return result;
    }
    renderTemplate(template, context, element, snapshot) {
        let serialized = this.renderServerSide(template, context, snapshot);
        replaceHTML(element, serialized);
        qunitFixture().appendChild(element);
        return this.renderClientSide(template, context, element);
    }
    registerComponent(type, _testType, name, layout) {
        registerComponent(this.clientRegistry, type, name, layout);
        registerComponent(this.serverRegistry, type, name, layout);
    }
    registerHelper(name, helper) {
        registerHelper(this.clientRegistry, name, helper);
        registerHelper(this.serverRegistry, name, helper);
    }
    registerModifier(name, ModifierClass) {
        registerModifier(this.clientRegistry, name, ModifierClass);
        registerModifier(this.serverRegistry, name, ModifierClass);
    }
}
RehydrationDelegate.isEager = false;
RehydrationDelegate.style = 'rehydration';
export function qunitFixture() {
    return document.getElementById('qunit-fixture');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVsZWdhdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9saWIvbW9kZXMvcmVoeWRyYXRpb24vZGVsZWdhdGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBUUEsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2pELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ3hELE9BQU8sa0JBQWtCLE1BQU0sc0JBQXNCLENBQUM7QUFHdEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUlsRSxPQUFPLEVBQUUsa0JBQWtCLEVBQTBCLE1BQU0saUJBQWlCLENBQUM7QUFDN0UsT0FBTyxFQUFFLGlCQUFpQixFQUFFLGNBQWMsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBRXRGLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDL0MsT0FBTyxzQkFBc0IsTUFBTSxpQkFBaUIsQ0FBQztBQUNyRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQTJCLE1BQU0sV0FBVyxDQUFDO0FBTXRFLE1BQU0sT0FBTyxtQkFBbUI7SUFvQjlCO1FBRlEsU0FBSSxHQUErQixJQUFJLENBQUM7UUFHOUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxRQUEwQixDQUFDO1FBQzVDLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxzQkFBc0IsRUFBRSxDQUFDO1FBQ25ELElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUM7UUFDbkQsSUFBSSxDQUFDLFNBQVMsR0FBRyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxjQUFjLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBRTlGLElBQUksQ0FBQyxTQUFTLEdBQUcsa0JBQWtCLEVBQUUsQ0FBQztRQUN0QyxJQUFJLENBQUMs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QUFDO0FBQ25FLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDdXJzb3IsXG4gIERpY3QsXG4gIEVsZW1lbnRCdWlsZGVyLFxuICBFbnZpcm9ubWVudCxcbiAgUmVuZGVyUmVzdWx0LFxuICBPcHRpb24sXG59IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgc2VyaWFsaXplQnVpbGRlciB9IGZyb20gJ0BnbGltbWVyL25vZGUnO1xuaW1wb3J0IHsgVXBkYXRhYmxlUmVmZXJlbmNlIH0gZnJvbSAnQGdsaW1tZXIvcmVmZXJlbmNlJztcbmltcG9ydCBjcmVhdGVIVE1MRG9jdW1lbnQgZnJvbSAnQHNpbXBsZS1kb20vZG9jdW1lbnQnO1xuaW1wb3J0IHsgU2ltcGxlRG9jdW1lbnQsIFNpbXBsZUVsZW1lbnQsIFNpbXBsZU5vZGUgfSBmcm9tICdAc2ltcGxlLWRvbS9pbnRlcmZhY2UnO1xuaW1wb3J0IHsgQ29tcG9uZW50S2luZCB9IGZyb20gJy4uLy4uL2NvbXBvbmVudHMnO1xuaW1wb3J0IHsgcmVwbGFjZUhUTUwsIHRvSW5uZXJIVE1MIH0gZnJvbSAnLi4vLi4vZG9tL3NpbXBsZS11dGlscyc7XG5pbXBvcnQgeyBVc2VySGVscGVyIH0gZnJvbSAnLi4vLi4vaGVscGVycyc7XG5pbXBvcnQgeyBUZXN0TW9kaWZpZXJDb25zdHJ1Y3RvciB9IGZyb20gJy4uLy4uL21vZGlmaWVycyc7XG5pbXBvcnQgUmVuZGVyRGVsZWdhdGUgZnJvbSAnLi4vLi4vcmVuZGVyLWRlbGVnYXRlJztcbmltcG9ydCB7IEppdERlbGVnYXRlQ29udGV4dCwgSml0VGVzdERlbGVnYXRlQ29udGV4dCB9IGZyb20gJy4uL2ppdC9kZWxlZ2F0ZSc7XG5pbXBvcnQgeyByZWdpc3RlckNvbXBvbmVudCwgcmVnaXN0ZXJIZWxwZXIsIHJlZ2lzdGVyTW9kaWZpZXIgfSBmcm9tICcuLi9qaXQvcmVnaXN0ZXInO1xuaW1wb3J0IHsgVGVzdEppdFJlZ2lzdHJ5IH0gZnJvbSAnLi4vaml0L3JlZ2lzdHJ5JztcbmltcG9ydCB7IHJlbmRlclRlbXBsYXRlIH0gZnJvbSAnLi4vaml0L3JlbmRlcic7XG5pbXBvcnQgVGVzdEppdFJ1bnRpbWVSZXNvbHZlciBmcm9tICcuLi9qaXQvcmVzb2x2ZXInO1xuaW1wb3J0IHsgZGVidWdSZWh5ZHJhdGlvbiwgRGVidWdSZWh5ZHJhdGlvbkJ1aWxkZXIgfSBmcm9tICcuL2J1aWxkZXInO1xuXG5leHBvcnQgaW50ZXJmYWNlIFJlaHlkcmF0aW9uU3RhdHMge1xuICBjbGVhcmVkTm9kZXM6IFNpbXBsZU5vZGVbXTtcbn1cblxuZXhwb3J0IGNsYXNzIFJlaHlkcmF0aW9uRGVsZWdhdGUgaW1wbGVtZW50cyBSZW5kZXJEZWxlZ2F0ZSB7XG4gIHN0YXRpYyByZWFkb25seSBpc0VhZ2VyID0gZmFsc2U7XG4gIHN0YXRpYyByZWFkb25seSBzdHlsZSA9ICdyZWh5ZHJhdGlvbic7XG5cbiAgcHVibGljIGNsaWVudEVudjogSml0VGVzdERlbGVnYXRlQ29udGV4dDtcbiAgcHVibGljIHNlcnZlckVudjogSml0VGVzdERlbGVnYXRlQ29udGV4dDtcblxuICBwcml2YXRlIGNsaWVudFJlc29sdmVyOiBUZXN0Sml0UnVudGltZVJlc29sdmVyO1xuICBwcml2YXRlIHNlcnZlclJlc29sdmVyOiBUZXN0Sml0UnVudGltZVJlc29sdmVyO1xuXG4gIHByaXZhdGUgY2xpZW50UmVnaXN0cnk6IFRlc3RKaXRSZWdpc3RyeTtcbiAgcHJpdmF0ZSBzZXJ2ZXJSZWdpc3RyeTogVGVzdEppdFJlZ2lzdHJ5O1xuXG4gIHB1YmxpYyBjbGllbnREb2M6IFNpbXBsZURvY3VtZW50O1xuICBwdWJsaWMgc2VydmVyRG9jOiBTaW1wbGVEb2N1bWVudDtcblxuICBwdWJsaWMgcmVoeWRyYXRpb25TdGF0cyE6IFJlaHlkcmF0aW9uU3RhdHM7XG5cbiAgcHJpdmF0ZSBzZWxmOiBPcHRpb248VXBkYXRhYmxlUmVmZXJlbmNlPiA9IG51bGw7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5jbGllbnREb2MgPSBkb2N1bWVudCBhcyBTaW1wbGVEb2N1bWVudDtcbiAgICB0aGlzLmNsaWVudFJlc29sdmVyID0gbmV3IFRlc3RKaXRSdW50aW1lUmVzb2x2ZXIoKTtcbiAgICB0aGlzLmNsaWVudFJlZ2lzdHJ5ID0gdGhpcy5jbGllbnRSZXNvbHZlci5yZWdpc3RyeTtcbiAgICB0aGlzLmNsaWVudEVudiA9IEppdERlbGVnYXRlQ29udGV4dCh0aGlzLmNsaWVudERvYywgdGhpcy5jbGllbnRSZXNvbHZlciwgdGhpcy5jbGllbnRSZWdpc3RyeSk7XG5cbiAgICB0aGlzLnNlcnZlckRvYyA9IGNyZWF0ZUhUTUxEb2N1bWVudCgpO1xuICAgIHRoaXMuc2VydmVyUmVzb2x2ZXIgPSBuZXcgVGVzdEppdFJ1bnRpbWVSZXNvbHZlcigpO1xuICAgIHRoaXMuc2VydmVyUmVnaXN0cnkgPSB0aGlzLnNlcnZlclJlc29sdmVyLnJlZ2lzdHJ5O1xuICAgIHRoaXMuc2VydmVyRW52ID0gSml0RGVsZWdhdGVDb250ZXh0KHRoaXMuc2VydmVyRG9jLCB0aGlzLnNlcnZlclJlc29sdmVyLCB0aGlzLnNlcnZlclJlZ2lzdHJ5KTtcbiAgfVxuXG4gIGdldEluaXRpYWxFbGVtZW50KCk6IFNpbXBsZUVsZW1lbnQge1xuICAgIHJldHVybiB0aGlzLmNsaWVudERvYy5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgfVxuXG4gIGNyZWF0ZUVsZW1lbnQodGFnTmFtZTogc3RyaW5nKTogU2ltcGxlRWxlbWVudCB7XG4gICAgcmV0dXJuIHRoaXMuY2xpZW50RG9jLmNyZWF0ZUVsZW1lbnQodGFnTmFtZSk7XG4gIH1cblxuICBnZXRFbGVtZW50QnVpbGRlcihlbnY6IEVudmlyb25tZW50LCBjdXJzb3I6IEN1cnNvcik6IEVsZW1lbnRCdWlsZGVyIHtcbiAgICBpZiAoY3Vyc29yLmVsZW1lbnQgaW5zdGFuY2VvZiBOb2RlKSB7XG4gICAgICByZXR1cm4gZGVidWdSZWh5ZHJhdGlvbihlbnYsIGN1cnNvcik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNlcmlhbGl6ZUJ1aWxkZXIoZW52LCBjdXJzb3IpO1xuICB9XG5cbiAgcmVuZGVyU2VydmVyU2lkZShcbiAgICB0ZW1wbGF0ZTogc3RyaW5nLFxuICAgIGNvbnRleHQ6IERpY3Q8dW5rbm93bj4sXG4gICAgdGFrZVNuYXBzaG90OiAoKSA9PiB2b2lkLFxuICAgIGVsZW1lbnQ6IFNpbXBsZUVsZW1lbnQgfCB1bmRlZmluZWQgPSB1bmRlZmluZWRcbiAgKTogc3RyaW5nIHtcbiAgICBlbGVtZW50ID0gZWxlbWVudCB8fCB0aGlzLnNlcnZlckRvYy5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICBsZXQgY3Vyc29yID0geyBlbGVtZW50LCBuZXh0U2libGluZzogbnVsbCB9O1xuICAgIC8vIEVtdWxhdGUgc2VydmVyLXNpZGUgcmVuZGVyXG4gICAgcmVuZGVyVGVtcGxhdGUoXG4gICAgICB0ZW1wbGF0ZSxcbiAgICAgIHRoaXMuc2VydmVyRW52LFxuICAgICAgdGhpcy5nZXRTZWxmKGNvbnRleHQpLFxuICAgICAgdGhpcy5nZXRFbGVtZW50QnVpbGRlcih0aGlzLnNlcnZlckVudi5ydW50aW1lLmVudiwgY3Vyc29yKVxuICAgICk7XG5cbiAgICB0YWtlU25hcHNob3QoKTtcbiAgICByZXR1cm4gdGhpcy5zZXJpYWxpemUoZWxlbWVudCk7XG4gIH1cblxuICBnZXRTZWxmKGNvbnRleHQ6IHVua25vd24pOiBVcGRhdGFibGVSZWZlcmVuY2Uge1xuICAgIGlmICghdGhpcy5zZWxmKSB7XG4gICAgICB0aGlzLnNlbGYgPSBuZXcgVXBkYXRhYmxlUmVmZXJlbmNlKGNvbnRleHQpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnNlbGY7XG4gIH1cblxuICBzZXJpYWxpemUoZWxlbWVudDogU2ltcGxlRWxlbWVudCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRvSW5uZXJIVE1MKGVsZW1lbnQpO1xuICB9XG5cbiAgcmVuZGVyQ2xpZW50U2lkZSh0ZW1wbGF0ZTogc3RyaW5nLCBjb250ZXh0OiBEaWN0PHVua25vd24+LCBlbGVtZW50OiBTaW1wbGVFbGVtZW50KTogUmVuZGVyUmVzdWx0IHtcbiAgICBsZXQgZW52ID0gdGhpcy5jbGllbnRFbnYucnVudGltZS5lbnY7XG4gICAgdGhpcy5zZWxmID0gbnVsbDtcblxuICAgIC8vIENsaWVudC1zaWRlIHJlaHlkcmF0aW9uXG4gICAgbGV0IGN1cnNvciA9IHsgZWxlbWVudCwgbmV4dFNpYmxpbmc6IG51bGwgfTtcbiAgICBsZXQgYnVpbGRlciA9IHRoaXMuZ2V0RWxlbWVudEJ1aWxkZXIoZW52LCBjdXJzb3IpIGFzIERlYnVnUmVoeWRyYXRpb25CdWlsZGVyO1xuICAgIGxldCByZXN1bHQgPSByZW5kZXJUZW1wbGF0ZSh0ZW1wbGF0ZSwgdGhpcy5jbGllbnRFbnYsIHRoaXMuZ2V0U2VsZihjb250ZXh0KSwgYnVpbGRlcik7XG5cbiAgICB0aGlzLnJlaHlkcmF0aW9uU3RhdHMgPSB7XG4gICAgICBjbGVhcmVkTm9kZXM6IGJ1aWxkZXJbJ2NsZWFyZWROb2RlcyddLFxuICAgIH07XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcmVuZGVyVGVtcGxhdGUoXG4gICAgdGVtcGxhdGU6IHN0cmluZyxcbiAgICBjb250ZXh0OiBEaWN0PHVua25vd24+LFxuICAgIGVsZW1lbnQ6IFNpbXBsZUVsZW1lbnQsXG4gICAgc25hcHNob3Q6ICgpID0+IHZvaWRcbiAgKTogUmVuZGVyUmVzdWx0IHtcbiAgICBsZXQgc2VyaWFsaXplZCA9IHRoaXMucmVuZGVyU2VydmVyU2lkZSh0ZW1wbGF0ZSwgY29udGV4dCwgc25hcHNob3QpO1xuICAgIHJlcGxhY2VIVE1MKGVsZW1lbnQsIHNlcmlhbGl6ZWQpO1xuICAgIHF1bml0Rml4dHVyZSgpLmFwcGVuZENoaWxkKGVsZW1lbnQpO1xuXG4gICAgcmV0dXJuIHRoaXMucmVuZGVyQ2xpZW50U2lkZSh0ZW1wbGF0ZSwgY29udGV4dCwgZWxlbWVudCk7XG4gIH1cblxuICByZWdpc3RlckNvbXBvbmVudCh0eXBlOiBDb21wb25lbnRLaW5kLCBfdGVzdFR5cGU6IHN0cmluZywgbmFtZTogc3RyaW5nLCBsYXlvdXQ6IHN0cmluZyk6IHZvaWQge1xuICAgIHJlZ2lzdGVyQ29tcG9uZW50KHRoaXMuY2xpZW50UmVnaXN0cnksIHR5cGUsIG5hbWUsIGxheW91dCk7XG4gICAgcmVnaXN0ZXJDb21wb25lbnQodGhpcy5zZXJ2ZXJSZWdpc3RyeSwgdHlwZSwgbmFtZSwgbGF5b3V0KTtcbiAgfVxuXG4gIHJlZ2lzdGVySGVscGVyKG5hbWU6IHN0cmluZywgaGVscGVyOiBVc2VySGVscGVyKTogdm9pZCB7XG4gICAgcmVnaXN0ZXJIZWxwZXIodGhpcy5jbGllbnRSZWdpc3RyeSwgbmFtZSwgaGVscGVyKTtcbiAgICByZWdpc3RlckhlbHBlcih0aGlzLnNlcnZlclJlZ2lzdHJ5LCBuYW1lLCBoZWxwZXIpO1xuICB9XG5cbiAgcmVnaXN0ZXJNb2RpZmllcihuYW1lOiBzdHJpbmcsIE1vZGlmaWVyQ2xhc3M6IFRlc3RNb2RpZmllckNvbnN0cnVjdG9yKTogdm9pZCB7XG4gICAgcmVnaXN0ZXJNb2RpZmllcih0aGlzLmNsaWVudFJlZ2lzdHJ5LCBuYW1lLCBNb2RpZmllckNsYXNzKTtcbiAgICByZWdpc3Rlck1vZGlmaWVyKHRoaXMuc2VydmVyUmVnaXN0cnksIG5hbWUsIE1vZGlmaWVyQ2xhc3MpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBxdW5pdEZpeHR1cmUoKTogU2ltcGxlRWxlbWVudCB7XG4gIHJldHVybiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncXVuaXQtZml4dHVyZScpIGFzIFNpbXBsZUVsZW1lbnQ7XG59XG4iXX0=
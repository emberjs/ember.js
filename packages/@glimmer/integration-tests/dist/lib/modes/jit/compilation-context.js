import { Constants, CompileTimeHeapImpl, RuntimeProgramImpl } from '@glimmer/program';
import { compileStd } from '@glimmer/opcode-compiler';
import { createTemplate } from '../../compile';
export class TestJitCompilationContext {
    constructor(runtimeResolver, registry) {
        this.runtimeResolver = runtimeResolver;
        this.constants = new Constants(this.runtimeResolver);
        this.heap = new CompileTimeHeapImpl();
        this.mode = "jit" /* jit */;
        this.stdlib = compileStd(this);
        this.resolverDelegate = new JitCompileTimeLookup(runtimeResolver, registry);
    }
    program() {
        return new RuntimeProgramImpl(this.constants, this.heap);
    }
}
export default class JitCompileTimeLookup {
    constructor(resolver, registry) {
        this.resolver = resolver;
        this.registry = registry;
    }
    resolve(handle) {
        return this.resolver.resolve(handle);
    }
    getCapabilities(handle) {
        let definition = this.resolver.resolve(handle);
        let { manager, state } = definition;
        return manager.getCapabilities(state);
    }
    lookupHelper(name, referrer) {
        return this.resolver.lookupHelper(name, referrer);
    }
    lookupModifier(name, referrer) {
        return this.resolver.lookupModifier(name, referrer);
    }
    // name is a cache key
    compile(source, name) {
        // throw new Error('NOPE');
        // TODO: This whole thing probably should have a more first-class
        // structure.
        return this.registry.templateFromSource(source, name, source => {
            let factory = createTemplate(source);
            return factory.create();
        });
    }
    lookupComponent(name, referrer) {
        let definitionHandle = this.registry.lookupComponentHandle(name, referrer);
        if (definitionHandle === null) {
            return null;
        }
        let capabilities = this.getCapabilities(definitionHandle);
        if (capabilities.dynamicLayout) {
            return {
                handle: definitionHandle,
                capabilities,
                compilable: null,
            };
        }
        let templateHandle = this.resolver.lookup('template-source', name, null);
        if (templateHandle === null) {
            throw new Error(`missing compile-time layout, but component ${name} didn't have the dynamicLayout capability`);
        }
        let source = this.resolve(templateHandle);
        if (source === null || typeof source !== 'string') {
            throw new Error('UH OH');
        }
        let template = this.compile(source, name);
        let compilable = capabilities.wrapped ? template.asWrappedLayout() : template.asLayout();
        return {
            handle: definitionHandle,
            capabilities,
            compilable,
        };
    }
    lookupPartial(name, referrer) {
        return this.resolver.lookupPartial(name, referrer);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGlsYXRpb24tY29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2xpYi9tb2Rlcy9qaXQvY29tcGlsYXRpb24tY29udGV4dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFjQSxPQUFPLEVBQUUsU0FBUyxFQUFFLG1CQUFtQixFQUFFLGtCQUFrQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFdEYsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRXRELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFL0MsTUFBTSxPQUFPLHlCQUF5QjtJQU9wQyxZQUFvQixlQUF1QyxFQUFFLFFBQXlCO1FBQWxFLG9CQUFlLEdBQWYsZUFBZSxDQUF3QjtRQU5sRCxjQUFTLEdBQUcsSUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBRWhELFNBQUksR0FBRyxJQUFJLG1CQUFtQixFQUFFLENBQUM7UUFDakMsU0FBSSxtQkFBbUI7UUFJOUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDL0IsSUFBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksb0JBQW9CLENBQUMsZUFBZSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzlFLENBQUM7SUFFRCxPQUFPO1FBQ0wsT0FBTyxJQUFJLGtCQUFrQixDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzNELENBQUM7Q0FDRjtBQUVELE1BQU0sQ0FBQyxPQUFPLE9BQU8sb0JBQW9CO0lBQ3ZDLFlBQW9CLFFBQWdDLEVBQVUsUUFBeUI7UUFBbkUsYUFBUSxHQUFSLFFBQVEsQ0FBd0I7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFpQjtJQUFHLENBQUM7SUFFM0YsT0FBTyxDQUFJLE1BQWM7UUFDdkIsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBRU8sZUFBZSxDQUFDLE1BQWM7UUFDcEMsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQThCLE1BQU0sQ0FBQyxDQUFDO1FBQzVFLElBQUksRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLEdBQUcsVUFBVyxDQUFDO1FBQ3JDLE9BQU8sT0FBTyxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBRUQsWUFBWSxDQUFDLElBQVksRUFBRSxRQUE4QztRQUN2RSxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBRUQsY0FBYyxDQUFDLElBQVksRUFBRSxRQUE4QztRQUN6RSxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRUQsc0JBQXNCO0lBQ3RCLE9BQU8sQ0FBQyxNQUFjLEVBQUUsSUFBWTtRQUNsQywyQkFBMkI7UUFDM0IsaUVBQWlFO1FBQ2pFLGFBQWE7UUFDYixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsa0JBQWtCLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxNQUFNLENBQUMsRUFBRTtZQUM3RCxJQUFJLE9BQU8sR0FBRyxjQUFjLENBQXlCLE1BQU0sQ0FBQyxDQUFDO1lBQzdELE9BQU8sT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQzFCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELGVBQWUsQ0FDYixJQUFZLEVBQ1osUUFBc0Q7UUFFdEQsSUFBSSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLHFCQUFxQixDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztRQUUzRSxJQUFJLGdCQUFnQixLQUFLLElBQUksRUFBRTtZQUM3QixPQUFPLElBQUksQ0FBQztTQUNiO1FBRUQsSUFBSSxZQUFZLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBRTFELElBQUksWUFBWSxDQUFDLGFBQWEsRUFBRTtZQUM5QixPQUFPO2dCQUNMLE1BQU0sRUFBRSxnQkFBZ0I7Z0JBQ3hCLFlBQVk7Z0JBQ1osVUFBVSxFQUFFLElBQUk7YUFDakIsQ0FBQztTQUNIO1FBRUQsSUFBSSxjQUFjLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsaUJBQWlCLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRXpFLElBQUksY0FBYyxLQUFLLElBQUksRUFBRTtZQUMzQixNQUFNLElBQUksS0FBSyxDQUNiLDhDQUE4QyxJQUFJLDJDQUEyQyxDQUM5RixDQUFDO1NBQ0g7UUFFRCxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFTLGNBQWMsQ0FBQyxDQUFDO1FBRWxELElBQUksTUFBTSxLQUFLLElBQUksSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRLEVBQUU7WUFDakQsTUFBTSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUMxQjtRQUVELElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzFDLElBQUksVUFBVSxHQUFHLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBRXpGLE9BQU87WUFDTCxNQUFNLEVBQUUsZ0JBQWdCO1lBQ3hCLFlBQVk7WUFDWixVQUFVO1NBQ1gsQ0FBQztJQUNKLENBQUM7SUFFRCxhQUFhLENBQUMsSUFBWSxFQUFFLFFBQThDO1FBQ3hFLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ3JELENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIFdob2xlUHJvZ3JhbUNvbXBpbGF0aW9uQ29udGV4dCxcbiAgQ29tcGlsZVRpbWVSZXNvbHZlckRlbGVnYXRlLFxuICBDb21waWxlTW9kZSxcbiAgU1RETGliLFxuICBSdW50aW1lUHJvZ3JhbSxcbiAgQ29tcG9uZW50Q2FwYWJpbGl0aWVzLFxuICBPcHRpb24sXG4gIENvbXBvbmVudERlZmluaXRpb24sXG4gIFRlbXBsYXRlTWV0YSxcbiAgQW5ub3RhdGVkTW9kdWxlTG9jYXRvcixcbiAgVGVtcGxhdGUsXG4gIENvbXBpbGVUaW1lQ29tcG9uZW50LFxufSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7IENvbnN0YW50cywgQ29tcGlsZVRpbWVIZWFwSW1wbCwgUnVudGltZVByb2dyYW1JbXBsIH0gZnJvbSAnQGdsaW1tZXIvcHJvZ3JhbSc7XG5pbXBvcnQgeyBUZXN0Sml0UmVnaXN0cnkgfSBmcm9tICcuL3JlZ2lzdHJ5JztcbmltcG9ydCB7IGNvbXBpbGVTdGQgfSBmcm9tICdAZ2xpbW1lci9vcGNvZGUtY29tcGlsZXInO1xuaW1wb3J0IFRlc3RKaXRSdW50aW1lUmVzb2x2ZXIgZnJvbSAnLi9yZXNvbHZlcic7XG5pbXBvcnQgeyBjcmVhdGVUZW1wbGF0ZSB9IGZyb20gJy4uLy4uL2NvbXBpbGUnO1xuXG5leHBvcnQgY2xhc3MgVGVzdEppdENvbXBpbGF0aW9uQ29udGV4dCBpbXBsZW1lbnRzIFdob2xlUHJvZ3JhbUNvbXBpbGF0aW9uQ29udGV4dCB7XG4gIHJlYWRvbmx5IGNvbnN0YW50cyA9IG5ldyBDb25zdGFudHModGhpcy5ydW50aW1lUmVzb2x2ZXIpO1xuICByZWFkb25seSByZXNvbHZlckRlbGVnYXRlOiBKaXRDb21waWxlVGltZUxvb2t1cDtcbiAgcmVhZG9ubHkgaGVhcCA9IG5ldyBDb21waWxlVGltZUhlYXBJbXBsKCk7XG4gIHJlYWRvbmx5IG1vZGUgPSBDb21waWxlTW9kZS5qaXQ7XG4gIHJlYWRvbmx5IHN0ZGxpYjogU1RETGliO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcnVudGltZVJlc29sdmVyOiBUZXN0Sml0UnVudGltZVJlc29sdmVyLCByZWdpc3RyeTogVGVzdEppdFJlZ2lzdHJ5KSB7XG4gICAgdGhpcy5zdGRsaWIgPSBjb21waWxlU3RkKHRoaXMpO1xuICAgIHRoaXMucmVzb2x2ZXJEZWxlZ2F0ZSA9IG5ldyBKaXRDb21waWxlVGltZUxvb2t1cChydW50aW1lUmVzb2x2ZXIsIHJlZ2lzdHJ5KTtcbiAgfVxuXG4gIHByb2dyYW0oKTogUnVudGltZVByb2dyYW0ge1xuICAgIHJldHVybiBuZXcgUnVudGltZVByb2dyYW1JbXBsKHRoaXMuY29uc3RhbnRzLCB0aGlzLmhlYXApO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEppdENvbXBpbGVUaW1lTG9va3VwIGltcGxlbWVudHMgQ29tcGlsZVRpbWVSZXNvbHZlckRlbGVnYXRlIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZXNvbHZlcjogVGVzdEppdFJ1bnRpbWVSZXNvbHZlciwgcHJpdmF0ZSByZWdpc3RyeTogVGVzdEppdFJlZ2lzdHJ5KSB7fVxuXG4gIHJlc29sdmU8VD4oaGFuZGxlOiBudW1iZXIpOiBUIHtcbiAgICByZXR1cm4gdGhpcy5yZXNvbHZlci5yZXNvbHZlKGhhbmRsZSk7XG4gIH1cblxuICBwcml2YXRlIGdldENhcGFiaWxpdGllcyhoYW5kbGU6IG51bWJlcik6IENvbXBvbmVudENhcGFiaWxpdGllcyB7XG4gICAgbGV0IGRlZmluaXRpb24gPSB0aGlzLnJlc29sdmVyLnJlc29sdmU8T3B0aW9uPENvbXBvbmVudERlZmluaXRpb24+PihoYW5kbGUpO1xuICAgIGxldCB7IG1hbmFnZXIsIHN0YXRlIH0gPSBkZWZpbml0aW9uITtcbiAgICByZXR1cm4gbWFuYWdlci5nZXRDYXBhYmlsaXRpZXMoc3RhdGUpO1xuICB9XG5cbiAgbG9va3VwSGVscGVyKG5hbWU6IHN0cmluZywgcmVmZXJyZXI6IFRlbXBsYXRlTWV0YTxBbm5vdGF0ZWRNb2R1bGVMb2NhdG9yPik6IE9wdGlvbjxudW1iZXI+IHtcbiAgICByZXR1cm4gdGhpcy5yZXNvbHZlci5sb29rdXBIZWxwZXIobmFtZSwgcmVmZXJyZXIpO1xuICB9XG5cbiAgbG9va3VwTW9kaWZpZXIobmFtZTogc3RyaW5nLCByZWZlcnJlcjogVGVtcGxhdGVNZXRhPEFubm90YXRlZE1vZHVsZUxvY2F0b3I+KTogT3B0aW9uPG51bWJlcj4ge1xuICAgIHJldHVybiB0aGlzLnJlc29sdmVyLmxvb2t1cE1vZGlmaWVyKG5hbWUsIHJlZmVycmVyKTtcbiAgfVxuXG4gIC8vIG5hbWUgaXMgYSBjYWNoZSBrZXlcbiAgY29tcGlsZShzb3VyY2U6IHN0cmluZywgbmFtZTogc3RyaW5nKTogVGVtcGxhdGUge1xuICAgIC8vIHRocm93IG5ldyBFcnJvcignTk9QRScpO1xuICAgIC8vIFRPRE86IFRoaXMgd2hvbGUgdGhpbmcgcHJvYmFibHkgc2hvdWxkIGhhdmUgYSBtb3JlIGZpcnN0LWNsYXNzXG4gICAgLy8gc3RydWN0dXJlLlxuICAgIHJldHVybiB0aGlzLnJlZ2lzdHJ5LnRlbXBsYXRlRnJvbVNvdXJjZShzb3VyY2UsIG5hbWUsIHNvdXJjZSA9PiB7XG4gICAgICBsZXQgZmFjdG9yeSA9IGNyZWF0ZVRlbXBsYXRlPEFubm90YXRlZE1vZHVsZUxvY2F0b3I+KHNvdXJjZSk7XG4gICAgICByZXR1cm4gZmFjdG9yeS5jcmVhdGUoKTtcbiAgICB9KTtcbiAgfVxuXG4gIGxvb2t1cENvbXBvbmVudChcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgcmVmZXJyZXI6IE9wdGlvbjxUZW1wbGF0ZU1ldGE8QW5ub3RhdGVkTW9kdWxlTG9jYXRvcj4+XG4gICk6IE9wdGlvbjxDb21waWxlVGltZUNvbXBvbmVudD4ge1xuICAgIGxldCBkZWZpbml0aW9uSGFuZGxlID0gdGhpcy5yZWdpc3RyeS5sb29rdXBDb21wb25lbnRIYW5kbGUobmFtZSwgcmVmZXJyZXIpO1xuXG4gICAgaWYgKGRlZmluaXRpb25IYW5kbGUgPT09IG51bGwpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGxldCBjYXBhYmlsaXRpZXMgPSB0aGlzLmdldENhcGFiaWxpdGllcyhkZWZpbml0aW9uSGFuZGxlKTtcblxuICAgIGlmIChjYXBhYmlsaXRpZXMuZHluYW1pY0xheW91dCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaGFuZGxlOiBkZWZpbml0aW9uSGFuZGxlLFxuICAgICAgICBjYXBhYmlsaXRpZXMsXG4gICAgICAgIGNvbXBpbGFibGU6IG51bGwsXG4gICAgICB9O1xuICAgIH1cblxuICAgIGxldCB0ZW1wbGF0ZUhhbmRsZSA9IHRoaXMucmVzb2x2ZXIubG9va3VwKCd0ZW1wbGF0ZS1zb3VyY2UnLCBuYW1lLCBudWxsKTtcblxuICAgIGlmICh0ZW1wbGF0ZUhhbmRsZSA9PT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgbWlzc2luZyBjb21waWxlLXRpbWUgbGF5b3V0LCBidXQgY29tcG9uZW50ICR7bmFtZX0gZGlkbid0IGhhdmUgdGhlIGR5bmFtaWNMYXlvdXQgY2FwYWJpbGl0eWBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgbGV0IHNvdXJjZSA9IHRoaXMucmVzb2x2ZTxzdHJpbmc+KHRlbXBsYXRlSGFuZGxlKTtcblxuICAgIGlmIChzb3VyY2UgPT09IG51bGwgfHwgdHlwZW9mIHNvdXJjZSAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVUggT0gnKTtcbiAgICB9XG5cbiAgICBsZXQgdGVtcGxhdGUgPSB0aGlzLmNvbXBpbGUoc291cmNlLCBuYW1lKTtcbiAgICBsZXQgY29tcGlsYWJsZSA9IGNhcGFiaWxpdGllcy53cmFwcGVkID8gdGVtcGxhdGUuYXNXcmFwcGVkTGF5b3V0KCkgOiB0ZW1wbGF0ZS5hc0xheW91dCgpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGhhbmRsZTogZGVmaW5pdGlvbkhhbmRsZSxcbiAgICAgIGNhcGFiaWxpdGllcyxcbiAgICAgIGNvbXBpbGFibGUsXG4gICAgfTtcbiAgfVxuXG4gIGxvb2t1cFBhcnRpYWwobmFtZTogc3RyaW5nLCByZWZlcnJlcjogVGVtcGxhdGVNZXRhPEFubm90YXRlZE1vZHVsZUxvY2F0b3I+KTogT3B0aW9uPG51bWJlcj4ge1xuICAgIHJldHVybiB0aGlzLnJlc29sdmVyLmxvb2t1cFBhcnRpYWwobmFtZSwgcmVmZXJyZXIpO1xuICB9XG59XG4iXX0=
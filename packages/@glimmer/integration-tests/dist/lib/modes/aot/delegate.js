import { BundleCompiler, DebugConstants, ModuleLocatorMap, } from '@glimmer/bundle-compiler';
import { WrappedBuilder } from '@glimmer/opcode-compiler';
import { StableState } from '@glimmer/reference';
import { clientBuilder, getDynamicVar, renderAotComponent, renderAotMain, renderSync, AotRuntime, } from '@glimmer/runtime';
import { assert, assign, expect } from '@glimmer/util';
import { BasicComponent, BasicComponentManager } from '../../components/basic';
import { EmberishCurlyComponent, EmberishCurlyComponentManager, } from '../../components/emberish-curly';
import { EmberishGlimmerComponent, EmberishGlimmerComponentManager, EMBERISH_GLIMMER_CAPABILITIES, } from '../../components/emberish-glimmer';
import { BASIC_CAPABILITIES, EMBERISH_CURLY_CAPABILITIES } from '../../components/capabilities';
import { AotCompilerRegistry, Modules } from './registry';
import { locatorFor } from '../../locator';
import { HelperReference } from '../../helpers';
import { TestModifierDefinitionState, TestModifierManager, } from '../../modifiers';
import AotRuntimeResolver from './resolver';
import { TestMacros } from '../../compile/macros';
import AotCompilerDelegate from './compiler-delegate';
const COMPONENT_CLASSES = {
    Basic: BasicComponent,
    Glimmer: EmberishGlimmerComponent,
    Dynamic: EmberishCurlyComponent,
    Curly: EmberishCurlyComponent,
    Fragment: null,
};
const COMPONENT_MANAGERS = {
    Basic: new BasicComponentManager(),
    Glimmer: new EmberishGlimmerComponentManager(),
    Dynamic: new EmberishCurlyComponentManager(),
    Curly: new EmberishCurlyComponentManager(),
    Fragment: null,
};
const COMPONENT_CAPABILITIES = {
    Basic: BASIC_CAPABILITIES,
    Glimmer: EMBERISH_GLIMMER_CAPABILITIES,
    Dynamic: EMBERISH_CURLY_CAPABILITIES,
    Curly: EMBERISH_CURLY_CAPABILITIES,
    Fragment: null,
};
export class AotRenderDelegate {
    constructor(doc) {
        this.registry = new AotCompilerRegistry();
        this.compileTimeModules = new Modules();
        this.symbolTables = new ModuleLocatorMap();
        this.registerInternalHelper('-get-dynamic-var', getDynamicVar);
        this.doc = doc || document;
    }
    registerInternalHelper(name, helper) {
        this.registry.register(name, 'helper', { default: helper });
        return helper;
    }
    getElementBuilder(env, cursor) {
        return clientBuilder(env, cursor);
    }
    getInitialElement() {
        return this.doc.createElement('div');
    }
    createElement(tagName) {
        return this.doc.createElement(tagName);
    }
    registerComponent(type, testType, name, template, Class) {
        let module = `ui/components/${name}`;
        let ComponentClass = Class || COMPONENT_CLASSES[type];
        let manager = COMPONENT_MANAGERS[type];
        let capabilities = COMPONENT_CAPABILITIES[type];
        if (!manager || !capabilities) {
            throw new Error(`Not implemented in the Bundle Compiler yet: ${type}`);
        }
        let hasSymbolTable = testType === 'Dynamic';
        let state = {
            name,
            type,
            template,
            capabilities,
            hasSymbolTable,
            ComponentClass,
            locator: locatorFor({ module, name: 'default' }),
            // Populated by the Bundle Compiler in eager mode
            layout: null,
        };
        this.registry.addComponent(module, manager, state);
    }
    getSelf(context) {
        return StableState(context);
    }
    registerHelper(name, helper) {
        let glimmerHelper = args => new HelperReference(helper, args);
        this.registry.register(name, 'helper', { default: glimmerHelper });
    }
    registerModifier(name, ModifierClass) {
        let state = new TestModifierDefinitionState(ModifierClass);
        let manager = new TestModifierManager();
        this.registry.register(name, 'modifier', { default: { manager, state } });
    }
    addRegisteredComponents(bundleCompiler) {
        let { registry, compileTimeModules } = this;
        Object.keys(registry.components).forEach(key => {
            assert(key.indexOf('ui/components') !== -1, `Expected component key to start with ui/components, got ${key}.`);
            let { state, manager } = registry.components[key];
            let locator = locatorFor({ module: key, name: 'default' });
            let block;
            let symbolTable;
            if (state.type === 'Curly' || state.type === 'Dynamic') {
                let block = bundleCompiler.preprocess(state.template);
                let parsedLayout = { block, referrer: locator.meta, asPartial: false };
                let wrapped = new WrappedBuilder(parsedLayout);
                bundleCompiler.addCompilableTemplate(locator, wrapped);
                compileTimeModules.register(key, 'other', {
                    default: wrapped.symbolTable,
                });
                symbolTable = wrapped.symbolTable;
                this.symbolTables.set(locator, symbolTable);
            }
            else {
                block = bundleCompiler.add(locator, expect(state.template, 'expected component definition state to have template'));
                symbolTable = {
                    hasEval: block.hasEval,
                    symbols: block.symbols,
                };
                this.symbolTables.set(locator, symbolTable);
                compileTimeModules.register(key, 'other', {
                    default: symbolTable,
                });
            }
            if (state.hasSymbolTable) {
                registry.register(key, 'component', {
                    default: {
                        state: assign({}, state, { symbolTable }),
                        manager,
                    },
                });
            }
            else {
                registry.register(key, 'component', {
                    default: {
                        state,
                        manager,
                    },
                });
            }
        });
    }
    getBundleCompiler() {
        let { compiler, constants } = getBundleCompiler(this.registry);
        this.constants = constants;
        return compiler;
    }
    getConstants() {
        return this.constants.toPool();
    }
    getRuntimeContext({ table, pool, heap, }) {
        let resolver = new AotRuntimeResolver(table, this.registry.modules, this.symbolTables);
        return AotRuntime(this.doc, { constants: pool, heap }, resolver);
    }
    renderComponent(name, args, element) {
        let bundleCompiler = this.getBundleCompiler();
        this.addRegisteredComponents(bundleCompiler);
        let compilationResult = bundleCompiler.compile();
        let cursor = { element, nextSibling: null };
        let runtime = this.getRuntimeContext(compilationResult);
        let builder = this.getElementBuilder(runtime.env, cursor);
        let iterator = renderAotComponent(runtime, builder, compilationResult.main, name, args);
        return renderSync(runtime.env, iterator);
    }
    renderTemplate(template, context, element) {
        this.registerComponent('Glimmer', 'Glimmer', 'main', template);
        let bundleCompiler = this.getBundleCompiler();
        let locator = locatorFor({ module: 'ui/components/main', name: 'default' });
        // bundleCompiler.add(locator, template);
        this.addRegisteredComponents(bundleCompiler);
        let compilationResult = bundleCompiler.compile();
        let handle = compilationResult.table.vmHandleByModuleLocator.get(locator);
        let cursor = { element, nextSibling: null };
        let runtime = this.getRuntimeContext(compilationResult);
        let builder = this.getElementBuilder(runtime.env, cursor);
        let self = this.getSelf(context);
        let iterator = renderAotMain(runtime, self, builder, handle);
        return renderSync(runtime.env, iterator);
    }
}
AotRenderDelegate.isEager = true;
AotRenderDelegate.style = 'aot';
function getBundleCompiler(registry) {
    let delegate = new AotCompilerDelegate(registry);
    let constants = new DebugConstants();
    let compiler = new BundleCompiler(delegate, {
        macros: new TestMacros(),
        constants,
    });
    return { constants, compiler };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVsZWdhdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9saWIvbW9kZXMvYW90L2RlbGVnYXRlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCxjQUFjLEVBQ2QsY0FBYyxFQUNkLGdCQUFnQixHQUNqQixNQUFNLDBCQUEwQixDQUFDO0FBaUJsQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDMUQsT0FBTyxFQUFxQyxXQUFXLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUNwRixPQUFPLEVBQ0wsYUFBYSxFQUNiLGFBQWEsRUFDYixrQkFBa0IsRUFDbEIsYUFBYSxFQUNiLFVBQVUsRUFDVixVQUFVLEdBQ1gsTUFBTSxrQkFBa0IsQ0FBQztBQUMxQixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFFL0QsT0FBTyxFQUFFLGNBQWMsRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQy9FLE9BQU8sRUFDTCxzQkFBc0IsRUFDdEIsNkJBQTZCLEdBQzlCLE1BQU0saUNBQWlDLENBQUM7QUFDekMsT0FBTyxFQUNMLHdCQUF3QixFQUN4QiwrQkFBK0IsRUFDL0IsNkJBQTZCLEdBQzlCLE1BQU0sbUNBQW1DLENBQUM7QUFJM0MsT0FBTyxFQUFFLGtCQUFrQixFQUFFLDJCQUEyQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDaEcsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE9BQU8sRUFBRSxNQUFNLFlBQVksQ0FBQztBQUMxRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFBYyxlQUFlLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDNUQsT0FBTyxFQUVMLDJCQUEyQixFQUMzQixtQkFBbUIsR0FDcEIsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QixPQUFPLGtCQUFrQixNQUFNLFlBQVks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QUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsQ0FBQztBQUNqQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQnVuZGxlQ29tcGlsYXRpb25SZXN1bHQsXG4gIEJ1bmRsZUNvbXBpbGVyLFxuICBEZWJ1Z0NvbnN0YW50cyxcbiAgTW9kdWxlTG9jYXRvck1hcCxcbn0gZnJvbSAnQGdsaW1tZXIvYnVuZGxlLWNvbXBpbGVyJztcbmltcG9ydCB7XG4gIENvbXBvbmVudENhcGFiaWxpdGllcyxcbiAgQ29tcG9uZW50RGVmaW5pdGlvbixcbiAgQ29tcG9uZW50TWFuYWdlcixcbiAgQ3Vyc29yLFxuICBEaWN0LFxuICBFbnZpcm9ubWVudCxcbiAgSGVscGVyIGFzIEdsaW1tZXJIZWxwZXIsXG4gIE1vZHVsZUxvY2F0b3IsXG4gIFByb2dyYW1TeW1ib2xUYWJsZSxcbiAgUmVuZGVyUmVzdWx0LFxuICBUZW1wbGF0ZU1ldGEsXG4gIEFvdFJ1bnRpbWVDb250ZXh0LFxuICBDb25zdGFudFBvb2wsXG4gIEVsZW1lbnRCdWlsZGVyLFxufSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7IFdyYXBwZWRCdWlsZGVyIH0gZnJvbSAnQGdsaW1tZXIvb3Bjb2RlLWNvbXBpbGVyJztcbmltcG9ydCB7IFBhdGhSZWZlcmVuY2UsIFVwZGF0YWJsZVJlZmVyZW5jZSwgU3RhYmxlU3RhdGUgfSBmcm9tICdAZ2xpbW1lci9yZWZlcmVuY2UnO1xuaW1wb3J0IHtcbiAgY2xpZW50QnVpbGRlcixcbiAgZ2V0RHluYW1pY1ZhcixcbiAgcmVuZGVyQW90Q29tcG9uZW50LFxuICByZW5kZXJBb3RNYWluLFxuICByZW5kZXJTeW5jLFxuICBBb3RSdW50aW1lLFxufSBmcm9tICdAZ2xpbW1lci9ydW50aW1lJztcbmltcG9ydCB7IGFzc2VydCwgYXNzaWduLCBleHBlY3QsIE9wdGlvbiB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgU2ltcGxlRWxlbWVudCwgU2ltcGxlRG9jdW1lbnQgfSBmcm9tICdAc2ltcGxlLWRvbS9pbnRlcmZhY2UnO1xuaW1wb3J0IHsgQmFzaWNDb21wb25lbnQsIEJhc2ljQ29tcG9uZW50TWFuYWdlciB9IGZyb20gJy4uLy4uL2NvbXBvbmVudHMvYmFzaWMnO1xuaW1wb3J0IHtcbiAgRW1iZXJpc2hDdXJseUNvbXBvbmVudCxcbiAgRW1iZXJpc2hDdXJseUNvbXBvbmVudE1hbmFnZXIsXG59IGZyb20gJy4uLy4uL2NvbXBvbmVudHMvZW1iZXJpc2gtY3VybHknO1xuaW1wb3J0IHtcbiAgRW1iZXJpc2hHbGltbWVyQ29tcG9uZW50LFxuICBFbWJlcmlzaEdsaW1tZXJDb21wb25lbnRNYW5hZ2VyLFxuICBFTUJFUklTSF9HTElNTUVSX0NBUEFCSUxJVElFUyxcbn0gZnJvbSAnLi4vLi4vY29tcG9uZW50cy9lbWJlcmlzaC1nbGltbWVyJztcbmltcG9ydCBSZW5kZXJEZWxlZ2F0ZSBmcm9tICcuLi8uLi9yZW5kZXItZGVsZWdhdGUnO1xuaW1wb3J0IHsgVGVzdENvbXBvbmVudERlZmluaXRpb25TdGF0ZSwgV3JhcHBlZExvY2F0b3IgfSBmcm9tICcuLi8uLi9jb21wb25lbnRzL3Rlc3QtY29tcG9uZW50JztcbmltcG9ydCB7IENvbXBvbmVudEtpbmQgfSBmcm9tICcuLi8uLi9jb21wb25lbnRzL3R5cGVzJztcbmltcG9ydCB7IEJBU0lDX0NBUEFCSUxJVElFUywgRU1CRVJJU0hfQ1VSTFlfQ0FQQUJJTElUSUVTIH0gZnJvbSAnLi4vLi4vY29tcG9uZW50cy9jYXBhYmlsaXRpZXMnO1xuaW1wb3J0IHsgQW90Q29tcGlsZXJSZWdpc3RyeSwgTW9kdWxlcyB9IGZyb20gJy4vcmVnaXN0cnknO1xuaW1wb3J0IHsgbG9jYXRvckZvciB9IGZyb20gJy4uLy4uL2xvY2F0b3InO1xuaW1wb3J0IHsgVXNlckhlbHBlciwgSGVscGVyUmVmZXJlbmNlIH0gZnJvbSAnLi4vLi4vaGVscGVycyc7XG5pbXBvcnQge1xuICBUZXN0TW9kaWZpZXJDb25zdHJ1Y3RvcixcbiAgVGVzdE1vZGlmaWVyRGVmaW5pdGlvblN0YXRlLFxuICBUZXN0TW9kaWZpZXJNYW5hZ2VyLFxufSBmcm9tICcuLi8uLi9tb2RpZmllcnMnO1xuaW1wb3J0IEFvdFJ1bnRpbWVSZXNvbHZlciBmcm9tICcuL3Jlc29sdmVyJztcbmltcG9ydCB7IFRlc3RNYWNyb3MgfSBmcm9tICcuLi8uLi9jb21waWxlL21hY3Jvcyc7XG5pbXBvcnQgQW90Q29tcGlsZXJEZWxlZ2F0ZSBmcm9tICcuL2NvbXBpbGVyLWRlbGVnYXRlJztcblxuZXhwb3J0IHR5cGUgUmVuZGVyRGVsZWdhdGVDb21wb25lbnREZWZpbml0aW9uID0gQ29tcG9uZW50RGVmaW5pdGlvbjxUZXN0Q29tcG9uZW50RGVmaW5pdGlvblN0YXRlPjtcblxudHlwZSBFbnRyaWVzPFQ+ID0geyBbRiBpbiBDb21wb25lbnRLaW5kXTogT3B0aW9uPFQ+IH07XG5cbmNvbnN0IENPTVBPTkVOVF9DTEFTU0VTOiBFbnRyaWVzPHVua25vd24+ID0ge1xuICBCYXNpYzogQmFzaWNDb21wb25lbnQsXG4gIEdsaW1tZXI6IEVtYmVyaXNoR2xpbW1lckNvbXBvbmVudCxcbiAgRHluYW1pYzogRW1iZXJpc2hDdXJseUNvbXBvbmVudCxcbiAgQ3VybHk6IEVtYmVyaXNoQ3VybHlDb21wb25lbnQsXG4gIEZyYWdtZW50OiBudWxsLFxufTtcblxuY29uc3QgQ09NUE9ORU5UX01BTkFHRVJTOiBFbnRyaWVzPENvbXBvbmVudE1hbmFnZXI+ID0ge1xuICBCYXNpYzogbmV3IEJhc2ljQ29tcG9uZW50TWFuYWdlcigpLFxuICBHbGltbWVyOiBuZXcgRW1iZXJpc2hHbGltbWVyQ29tcG9uZW50TWFuYWdlcigpLFxuICBEeW5hbWljOiBuZXcgRW1iZXJpc2hDdXJseUNvbXBvbmVudE1hbmFnZXIoKSxcbiAgQ3VybHk6IG5ldyBFbWJlcmlzaEN1cmx5Q29tcG9uZW50TWFuYWdlcigpLFxuICBGcmFnbWVudDogbnVsbCxcbn07XG5cbmNvbnN0IENPTVBPTkVOVF9DQVBBQklMSVRJRVM6IEVudHJpZXM8Q29tcG9uZW50Q2FwYWJpbGl0aWVzPiA9IHtcbiAgQmFzaWM6IEJBU0lDX0NBUEFCSUxJVElFUyxcbiAgR2xpbW1lcjogRU1CRVJJU0hfR0xJTU1FUl9DQVBBQklMSVRJRVMsXG4gIER5bmFtaWM6IEVNQkVSSVNIX0NVUkxZX0NBUEFCSUxJVElFUyxcbiAgQ3VybHk6IEVNQkVSSVNIX0NVUkxZX0NBUEFCSUxJVElFUyxcbiAgRnJhZ21lbnQ6IG51bGwsXG59O1xuXG5leHBvcnQgY2xhc3MgQW90UmVuZGVyRGVsZWdhdGUgaW1wbGVtZW50cyBSZW5kZXJEZWxlZ2F0ZSB7XG4gIHN0YXRpYyByZWFkb25seSBpc0VhZ2VyID0gdHJ1ZTtcbiAgc3RhdGljIHN0eWxlID0gJ2FvdCc7XG5cbiAgcHJvdGVjdGVkIHJlZ2lzdHJ5ID0gbmV3IEFvdENvbXBpbGVyUmVnaXN0cnkoKTtcbiAgcHJvdGVjdGVkIGNvbXBpbGVUaW1lTW9kdWxlcyA9IG5ldyBNb2R1bGVzKCk7XG4gIHByb3RlY3RlZCBzeW1ib2xUYWJsZXMgPSBuZXcgTW9kdWxlTG9jYXRvck1hcDxQcm9ncmFtU3ltYm9sVGFibGUsIE1vZHVsZUxvY2F0b3I+KCk7XG4gIHB1YmxpYyBjb25zdGFudHMhOiBEZWJ1Z0NvbnN0YW50cztcbiAgcHJpdmF0ZSBkb2M6IFNpbXBsZURvY3VtZW50O1xuXG4gIGNvbnN0cnVjdG9yKGRvYz86IFNpbXBsZURvY3VtZW50KSB7XG4gICAgdGhpcy5yZWdpc3RlckludGVybmFsSGVscGVyKCctZ2V0LWR5bmFtaWMtdmFyJywgZ2V0RHluYW1pY1Zhcik7XG4gICAgdGhpcy5kb2MgPSBkb2MgfHwgKGRvY3VtZW50IGFzIFNpbXBsZURvY3VtZW50KTtcbiAgfVxuXG4gIHByaXZhdGUgcmVnaXN0ZXJJbnRlcm5hbEhlbHBlcihuYW1lOiBzdHJpbmcsIGhlbHBlcjogR2xpbW1lckhlbHBlcik6IEdsaW1tZXJIZWxwZXIge1xuICAgIHRoaXMucmVnaXN0cnkucmVnaXN0ZXIobmFtZSwgJ2hlbHBlcicsIHsgZGVmYXVsdDogaGVscGVyIH0pO1xuICAgIHJldHVybiBoZWxwZXI7XG4gIH1cblxuICBnZXRFbGVtZW50QnVpbGRlcihlbnY6IEVudmlyb25tZW50LCBjdXJzb3I6IEN1cnNvcik6IEVsZW1lbnRCdWlsZGVyIHtcbiAgICByZXR1cm4gY2xpZW50QnVpbGRlcihlbnYsIGN1cnNvcik7XG4gIH1cblxuICBnZXRJbml0aWFsRWxlbWVudCgpOiBTaW1wbGVFbGVtZW50IHtcbiAgICByZXR1cm4gdGhpcy5kb2MuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gIH1cblxuICBjcmVhdGVFbGVtZW50KHRhZ05hbWU6IHN0cmluZyk6IFNpbXBsZUVsZW1lbnQge1xuICAgIHJldHVybiB0aGlzLmRvYy5jcmVhdGVFbGVtZW50KHRhZ05hbWUpO1xuICB9XG5cbiAgcmVnaXN0ZXJDb21wb25lbnQoXG4gICAgdHlwZTogQ29tcG9uZW50S2luZCxcbiAgICB0ZXN0VHlwZTogQ29tcG9uZW50S2luZCxcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgdGVtcGxhdGU6IHN0cmluZyxcbiAgICBDbGFzcz86IHVua25vd25cbiAgKTogdm9pZCB7XG4gICAgbGV0IG1vZHVsZSA9IGB1aS9jb21wb25lbnRzLyR7bmFtZX1gO1xuXG4gICAgbGV0IENvbXBvbmVudENsYXNzID0gQ2xhc3MgfHwgQ09NUE9ORU5UX0NMQVNTRVNbdHlwZV07XG4gICAgbGV0IG1hbmFnZXIgPSBDT01QT05FTlRfTUFOQUdFUlNbdHlwZV07XG4gICAgbGV0IGNhcGFiaWxpdGllcyA9IENPTVBPTkVOVF9DQVBBQklMSVRJRVNbdHlwZV07XG5cbiAgICBpZiAoIW1hbmFnZXIgfHwgIWNhcGFiaWxpdGllcykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBOb3QgaW1wbGVtZW50ZWQgaW4gdGhlIEJ1bmRsZSBDb21waWxlciB5ZXQ6ICR7dHlwZX1gKTtcbiAgICB9XG5cbiAgICBsZXQgaGFzU3ltYm9sVGFibGUgPSB0ZXN0VHlwZSA9PT0gJ0R5bmFtaWMnO1xuXG4gICAgbGV0IHN0YXRlOiBUZXN0Q29tcG9uZW50RGVmaW5pdGlvblN0YXRlID0ge1xuICAgICAgbmFtZSxcbiAgICAgIHR5cGUsXG4gICAgICB0ZW1wbGF0ZSxcbiAgICAgIGNhcGFiaWxpdGllcyxcbiAgICAgIGhhc1N5bWJvbFRhYmxlLFxuICAgICAgQ29tcG9uZW50Q2xhc3MsXG4gICAgICBsb2NhdG9yOiBsb2NhdG9yRm9yKHsgbW9kdWxlLCBuYW1lOiAnZGVmYXVsdCcgfSksXG4gICAgICAvLyBQb3B1bGF0ZWQgYnkgdGhlIEJ1bmRsZSBDb21waWxlciBpbiBlYWdlciBtb2RlXG4gICAgICBsYXlvdXQ6IG51bGwsXG4gICAgfTtcblxuICAgIHRoaXMucmVnaXN0cnkuYWRkQ29tcG9uZW50KG1vZHVsZSwgbWFuYWdlciwgc3RhdGUpO1xuICB9XG5cbiAgZ2V0U2VsZihjb250ZXh0OiBvYmplY3QpOiBVcGRhdGFibGVSZWZlcmVuY2Uge1xuICAgIHJldHVybiBTdGFibGVTdGF0ZShjb250ZXh0KTtcbiAgfVxuXG4gIHJlZ2lzdGVySGVscGVyKG5hbWU6IHN0cmluZywgaGVscGVyOiBVc2VySGVscGVyKTogdm9pZCB7XG4gICAgbGV0IGdsaW1tZXJIZWxwZXI6IEdsaW1tZXJIZWxwZXIgPSBhcmdzID0+IG5ldyBIZWxwZXJSZWZlcmVuY2UoaGVscGVyLCBhcmdzKTtcbiAgICB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdGVyKG5hbWUsICdoZWxwZXInLCB7IGRlZmF1bHQ6IGdsaW1tZXJIZWxwZXIgfSk7XG4gIH1cblxuICByZWdpc3Rlck1vZGlmaWVyKG5hbWU6IHN0cmluZywgTW9kaWZpZXJDbGFzczogVGVzdE1vZGlmaWVyQ29uc3RydWN0b3IpOiB2b2lkIHtcbiAgICBsZXQgc3RhdGUgPSBuZXcgVGVzdE1vZGlmaWVyRGVmaW5pdGlvblN0YXRlKE1vZGlmaWVyQ2xhc3MpO1xuICAgIGxldCBtYW5hZ2VyID0gbmV3IFRlc3RNb2RpZmllck1hbmFnZXIoKTtcbiAgICB0aGlzLnJlZ2lzdHJ5LnJlZ2lzdGVyKG5hbWUsICdtb2RpZmllcicsIHsgZGVmYXVsdDogeyBtYW5hZ2VyLCBzdGF0ZSB9IH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRSZWdpc3RlcmVkQ29tcG9uZW50cyhidW5kbGVDb21waWxlcjogQnVuZGxlQ29tcGlsZXI8V3JhcHBlZExvY2F0b3I+KTogdm9pZCB7XG4gICAgbGV0IHsgcmVnaXN0cnksIGNvbXBpbGVUaW1lTW9kdWxlcyB9ID0gdGhpcztcbiAgICBPYmplY3Qua2V5cyhyZWdpc3RyeS5jb21wb25lbnRzKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICBhc3NlcnQoXG4gICAgICAgIGtleS5pbmRleE9mKCd1aS9jb21wb25lbnRzJykgIT09IC0xLFxuICAgICAgICBgRXhwZWN0ZWQgY29tcG9uZW50IGtleSB0byBzdGFydCB3aXRoIHVpL2NvbXBvbmVudHMsIGdvdCAke2tleX0uYFxuICAgICAgKTtcblxuICAgICAgbGV0IHsgc3RhdGUsIG1hbmFnZXIgfSA9IHJlZ2lzdHJ5LmNvbXBvbmVudHNba2V5XTtcblxuICAgICAgbGV0IGxvY2F0b3IgPSBsb2NhdG9yRm9yKHsgbW9kdWxlOiBrZXksIG5hbWU6ICdkZWZhdWx0JyB9KTtcblxuICAgICAgbGV0IGJsb2NrO1xuICAgICAgbGV0IHN5bWJvbFRhYmxlO1xuXG4gICAgICBpZiAoc3RhdGUudHlwZSA9PT0gJ0N1cmx5JyB8fCBzdGF0ZS50eXBlID09PSAnRHluYW1pYycpIHtcbiAgICAgICAgbGV0IGJsb2NrID0gYnVuZGxlQ29tcGlsZXIucHJlcHJvY2VzcyhzdGF0ZS50ZW1wbGF0ZSEpO1xuICAgICAgICBsZXQgcGFyc2VkTGF5b3V0ID0geyBibG9jaywgcmVmZXJyZXI6IGxvY2F0b3IubWV0YSwgYXNQYXJ0aWFsOiBmYWxzZSB9O1xuICAgICAgICBsZXQgd3JhcHBlZCA9IG5ldyBXcmFwcGVkQnVpbGRlcihwYXJzZWRMYXlvdXQpO1xuICAgICAgICBidW5kbGVDb21waWxlci5hZGRDb21waWxhYmxlVGVtcGxhdGUobG9jYXRvciwgd3JhcHBlZCk7XG5cbiAgICAgICAgY29tcGlsZVRpbWVNb2R1bGVzLnJlZ2lzdGVyKGtleSwgJ290aGVyJywge1xuICAgICAgICAgIGRlZmF1bHQ6IHdyYXBwZWQuc3ltYm9sVGFibGUsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHN5bWJvbFRhYmxlID0gd3JhcHBlZC5zeW1ib2xUYWJsZTtcblxuICAgICAgICB0aGlzLnN5bWJvbFRhYmxlcy5zZXQobG9jYXRvciwgc3ltYm9sVGFibGUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYmxvY2sgPSBidW5kbGVDb21waWxlci5hZGQoXG4gICAgICAgICAgbG9jYXRvcixcbiAgICAgICAgICBleHBlY3Qoc3RhdGUudGVtcGxhdGUsICdleHBlY3RlZCBjb21wb25lbnQgZGVmaW5pdGlvbiBzdGF0ZSB0byBoYXZlIHRlbXBsYXRlJylcbiAgICAgICAgKTtcbiAgICAgICAgc3ltYm9sVGFibGUgPSB7XG4gICAgICAgICAgaGFzRXZhbDogYmxvY2suaGFzRXZhbCxcbiAgICAgICAgICBzeW1ib2xzOiBibG9jay5zeW1ib2xzLFxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMuc3ltYm9sVGFibGVzLnNldChsb2NhdG9yLCBzeW1ib2xUYWJsZSk7XG5cbiAgICAgICAgY29tcGlsZVRpbWVNb2R1bGVzLnJlZ2lzdGVyKGtleSwgJ290aGVyJywge1xuICAgICAgICAgIGRlZmF1bHQ6IHN5bWJvbFRhYmxlLFxuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgaWYgKHN0YXRlLmhhc1N5bWJvbFRhYmxlKSB7XG4gICAgICAgIHJlZ2lzdHJ5LnJlZ2lzdGVyKGtleSwgJ2NvbXBvbmVudCcsIHtcbiAgICAgICAgICBkZWZhdWx0OiB7XG4gICAgICAgICAgICBzdGF0ZTogYXNzaWduKHt9LCBzdGF0ZSwgeyBzeW1ib2xUYWJsZSB9KSxcbiAgICAgICAgICAgIG1hbmFnZXIsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZWdpc3RyeS5yZWdpc3RlcihrZXksICdjb21wb25lbnQnLCB7XG4gICAgICAgICAgZGVmYXVsdDoge1xuICAgICAgICAgICAgc3RhdGUsXG4gICAgICAgICAgICBtYW5hZ2VyLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRCdW5kbGVDb21waWxlcigpOiBCdW5kbGVDb21waWxlcjxXcmFwcGVkTG9jYXRvcj4ge1xuICAgIGxldCB7IGNvbXBpbGVyLCBjb25zdGFudHMgfSA9IGdldEJ1bmRsZUNvbXBpbGVyKHRoaXMucmVnaXN0cnkpO1xuICAgIHRoaXMuY29uc3RhbnRzID0gY29uc3RhbnRzO1xuXG4gICAgcmV0dXJuIGNvbXBpbGVyO1xuICB9XG5cbiAgZ2V0Q29uc3RhbnRzKCk6IENvbnN0YW50UG9vbCB7XG4gICAgcmV0dXJuIHRoaXMuY29uc3RhbnRzLnRvUG9vbCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRSdW50aW1lQ29udGV4dCh7XG4gICAgdGFibGUsXG4gICAgcG9vbCxcbiAgICBoZWFwLFxuICB9OiBCdW5kbGVDb21waWxhdGlvblJlc3VsdCk6IEFvdFJ1bnRpbWVDb250ZXh0PFRlbXBsYXRlTWV0YT4ge1xuICAgIGxldCByZXNvbHZlciA9IG5ldyBBb3RSdW50aW1lUmVzb2x2ZXIodGFibGUsIHRoaXMucmVnaXN0cnkubW9kdWxlcywgdGhpcy5zeW1ib2xUYWJsZXMpO1xuXG4gICAgcmV0dXJuIEFvdFJ1bnRpbWUodGhpcy5kb2MsIHsgY29uc3RhbnRzOiBwb29sLCBoZWFwIH0sIHJlc29sdmVyKTtcbiAgfVxuXG4gIHJlbmRlckNvbXBvbmVudChcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgYXJnczogRGljdDxQYXRoUmVmZXJlbmNlPHVua25vd24+PixcbiAgICBlbGVtZW50OiBTaW1wbGVFbGVtZW50XG4gICk6IFJlbmRlclJlc3VsdCB7XG4gICAgbGV0IGJ1bmRsZUNvbXBpbGVyID0gdGhpcy5nZXRCdW5kbGVDb21waWxlcigpO1xuICAgIHRoaXMuYWRkUmVnaXN0ZXJlZENvbXBvbmVudHMoYnVuZGxlQ29tcGlsZXIpO1xuICAgIGxldCBjb21waWxhdGlvblJlc3VsdCA9IGJ1bmRsZUNvbXBpbGVyLmNvbXBpbGUoKTtcblxuICAgIGxldCBjdXJzb3IgPSB7IGVsZW1lbnQsIG5leHRTaWJsaW5nOiBudWxsIH07XG4gICAgbGV0IHJ1bnRpbWUgPSB0aGlzLmdldFJ1bnRpbWVDb250ZXh0KGNvbXBpbGF0aW9uUmVzdWx0KTtcbiAgICBsZXQgYnVpbGRlciA9IHRoaXMuZ2V0RWxlbWVudEJ1aWxkZXIocnVudGltZS5lbnYsIGN1cnNvcik7XG4gICAgbGV0IGl0ZXJhdG9yID0gcmVuZGVyQW90Q29tcG9uZW50KHJ1bnRpbWUsIGJ1aWxkZXIsIGNvbXBpbGF0aW9uUmVzdWx0Lm1haW4sIG5hbWUsIGFyZ3MpO1xuXG4gICAgcmV0dXJuIHJlbmRlclN5bmMocnVudGltZS5lbnYsIGl0ZXJhdG9yKTtcbiAgfVxuXG4gIHJlbmRlclRlbXBsYXRlKHRlbXBsYXRlOiBzdHJpbmcsIGNvbnRleHQ6IERpY3Q8dW5rbm93bj4sIGVsZW1lbnQ6IFNpbXBsZUVsZW1lbnQpOiBSZW5kZXJSZXN1bHQge1xuICAgIHRoaXMucmVnaXN0ZXJDb21wb25lbnQoJ0dsaW1tZXInLCAnR2xpbW1lcicsICdtYWluJywgdGVtcGxhdGUpO1xuICAgIGxldCBidW5kbGVDb21waWxlciA9IHRoaXMuZ2V0QnVuZGxlQ29tcGlsZXIoKTtcbiAgICBsZXQgbG9jYXRvciA9IGxvY2F0b3JGb3IoeyBtb2R1bGU6ICd1aS9jb21wb25lbnRzL21haW4nLCBuYW1lOiAnZGVmYXVsdCcgfSk7XG4gICAgLy8gYnVuZGxlQ29tcGlsZXIuYWRkKGxvY2F0b3IsIHRlbXBsYXRlKTtcbiAgICB0aGlzLmFkZFJlZ2lzdGVyZWRDb21wb25lbnRzKGJ1bmRsZUNvbXBpbGVyKTtcblxuICAgIGxldCBjb21waWxhdGlvblJlc3VsdCA9IGJ1bmRsZUNvbXBpbGVyLmNvbXBpbGUoKTtcblxuICAgIGxldCBoYW5kbGUgPSBjb21waWxhdGlvblJlc3VsdC50YWJsZS52bUhhbmRsZUJ5TW9kdWxlTG9jYXRvci5nZXQobG9jYXRvcikhO1xuXG4gICAgbGV0IGN1cnNvciA9IHsgZWxlbWVudCwgbmV4dFNpYmxpbmc6IG51bGwgfTtcbiAgICBsZXQgcnVudGltZSA9IHRoaXMuZ2V0UnVudGltZUNvbnRleHQoY29tcGlsYXRpb25SZXN1bHQpO1xuICAgIGxldCBidWlsZGVyID0gdGhpcy5nZXRFbGVtZW50QnVpbGRlcihydW50aW1lLmVudiwgY3Vyc29yKTtcbiAgICBsZXQgc2VsZiA9IHRoaXMuZ2V0U2VsZihjb250ZXh0KTtcblxuICAgIGxldCBpdGVyYXRvciA9IHJlbmRlckFvdE1haW4ocnVudGltZSwgc2VsZiwgYnVpbGRlciwgaGFuZGxlKTtcblxuICAgIHJldHVybiByZW5kZXJTeW5jKHJ1bnRpbWUuZW52LCBpdGVyYXRvcik7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0QnVuZGxlQ29tcGlsZXIoXG4gIHJlZ2lzdHJ5OiBBb3RDb21waWxlclJlZ2lzdHJ5XG4pOiB7IGNvbXBpbGVyOiBCdW5kbGVDb21waWxlcjxXcmFwcGVkTG9jYXRvcj47IGNvbnN0YW50czogRGVidWdDb25zdGFudHMgfSB7XG4gIGxldCBkZWxlZ2F0ZTogQW90Q29tcGlsZXJEZWxlZ2F0ZSA9IG5ldyBBb3RDb21waWxlckRlbGVnYXRlKHJlZ2lzdHJ5KTtcbiAgbGV0IGNvbnN0YW50cyA9IG5ldyBEZWJ1Z0NvbnN0YW50cygpO1xuICBsZXQgY29tcGlsZXIgPSBuZXcgQnVuZGxlQ29tcGlsZXI8V3JhcHBlZExvY2F0b3I+KGRlbGVnYXRlLCB7XG4gICAgbWFjcm9zOiBuZXcgVGVzdE1hY3JvcygpLFxuICAgIGNvbnN0YW50cyxcbiAgfSk7XG4gIHJldHVybiB7IGNvbnN0YW50cywgY29tcGlsZXIgfTtcbn1cbiJdfQ==
import { combine, UpdatableReference, UpdatableDirtyableTag, } from '@glimmer/reference';
import { keys, templateMeta, assign } from '@glimmer/util';
import { BASIC_CAPABILITIES } from './capabilities';
const SELF_REF = new WeakMap();
function getSelf(obj) {
    if (SELF_REF.has(obj)) {
        return SELF_REF.get(obj);
    }
    else {
        let ref = new UpdatableReference(obj);
        SELF_REF.set(obj, ref);
        return ref;
    }
}
export class EmberishGlimmerComponent {
    constructor(_args) {
        this.dirtinessTag = UpdatableDirtyableTag.create();
        this.parentView = null;
    }
    static create({ attrs: args }) {
        let c = new this({ attrs: args });
        for (let key of keys(args)) {
            c[key] = args[key];
        }
        return c;
    }
    recompute() {
        getSelf(this).dirty();
    }
    destroy() { }
    didInitAttrs(_options) { }
    didUpdateAttrs(_diff) { }
    didReceiveAttrs(_diff) { }
    willInsertElement() { }
    willUpdate() { }
    willRender() { }
    didInsertElement() { }
    didUpdate() { }
    didRender() { }
}
export const EMBERISH_GLIMMER_CAPABILITIES = assign({}, BASIC_CAPABILITIES, {
    dynamicTag: true,
    createArgs: true,
    attributeHook: true,
    updateHook: true,
    createInstance: true,
});
export class EmberishGlimmerComponentManager {
    getCapabilities(state) {
        return state.capabilities;
    }
    prepareArgs() {
        return null;
    }
    create(_environment, definition, _args, _dynamicScope, _callerSelf, _hasDefaultBlock) {
        let args = _args.named.capture();
        let klass = definition.ComponentClass || EmberishGlimmerComponent;
        let attrs = args.value();
        let component = klass.create({ attrs });
        component.didInitAttrs({ attrs });
        component.didReceiveAttrs({ oldAttrs: null, newAttrs: attrs });
        component.willInsertElement();
        component.willRender();
        return { args, component };
    }
    getTag({ args: { tag }, component }) {
        return combine([tag, getSelf(component).tag]);
    }
    getJitStaticLayout(state, resolver) {
        return resolver.compilable(templateMeta(state.locator)).asLayout();
    }
    getAotStaticLayout(state, resolver) {
        let { locator } = state;
        return resolver.getInvocation(templateMeta(locator.meta.locator));
    }
    getSelf({ component }) {
        return getSelf(component);
    }
    didCreateElement() { }
    didRenderLayout({ component }, bounds) {
        component.bounds = bounds;
    }
    didCreate({ component }) {
        component.didInsertElement();
        component.didRender();
    }
    update({ args, component }) {
        let oldAttrs = component.attrs;
        let newAttrs = args.value();
        component.attrs = newAttrs;
        component.didUpdateAttrs({ oldAttrs, newAttrs });
        component.didReceiveAttrs({ oldAttrs, newAttrs });
        component.willUpdate();
        component.willRender();
    }
    didUpdateLayout() { }
    didUpdate({ component }) {
        component.didUpdate();
        component.didRender();
    }
    getDestructor({ component }) {
        return {
            destroy() {
                component.destroy();
            },
        };
    }
}
export function inspectHooks(ComponentClass) {
    return class extends ComponentClass {
        constructor() {
            super();
            this.hooks = {
                didInitAttrs: 0,
                didUpdateAttrs: 0,
                didReceiveAttrs: 0,
                willInsertElement: 0,
                willUpdate: 0,
                willRender: 0,
                didInsertElement: 0,
                didUpdate: 0,
                didRender: 0,
            };
        }
        didInitAttrs() {
            super.didInitAttrs(...arguments);
            this.hooks['didInitAttrs']++;
        }
        didUpdateAttrs() {
            super.didUpdateAttrs(...arguments);
            this.hooks['didUpdateAttrs']++;
        }
        didReceiveAttrs() {
            super.didReceiveAttrs(...arguments);
            this.hooks['didReceiveAttrs']++;
        }
        willInsertElement() {
            super.willInsertElement(...arguments);
            this.hooks['willInsertElement']++;
        }
        willUpdate() {
            super.willUpdate(...arguments);
            this.hooks['willUpdate']++;
        }
        willRender() {
            super.willRender(...arguments);
            this.hooks['willRender']++;
        }
        didInsertElement() {
            super.didInsertElement(...arguments);
            this.hooks['didInsertElement']++;
        }
        didUpdate() {
            super.didUpdate(...arguments);
            this.hooks['didUpdate']++;
        }
        didRender() {
            super.didRender(...arguments);
            this.hooks['didRender']++;
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1iZXJpc2gtZ2xpbW1lci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9jb21wb25lbnRzL2VtYmVyaXNoLWdsaW1tZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUdMLE9BQU8sRUFDUCxrQkFBa0IsRUFFbEIscUJBQXFCLEdBQ3RCLE1BQU0sb0JBQW9CLENBQUM7QUFtQjVCLE9BQU8sRUFBRSxJQUFJLEVBQUUsWUFBWSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQVNwRCxNQUFNLFFBQVEsR0FBRyxJQUFJLE9BQU8sRUFBZ0QsQ0FBQztBQUU3RSxTQUFTLE9BQU8sQ0FBQyxHQUE2QjtJQUM1QyxJQUFJLFFBQVEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDckIsT0FBTyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBRSxDQUFDO0tBQzNCO1NBQU07UUFDTCxJQUFJLEdBQUcsR0FBRyxJQUFJLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RDLFFBQVEsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ3ZCLE9BQU8sR0FBRyxDQUFDO0tBQ1o7QUFDSCxDQUFDO0FBRUQsTUFBTSxPQUFPLHdCQUF3QjtJQWlCbkMsWUFBWSxLQUEwQjtRQWhCL0IsaUJBQVksR0FBc0MscUJBQXFCLENBQUMsTUFBTSxFQUFFLENBQUM7UUFJakYsZUFBVSxHQUFxQyxJQUFJLENBQUM7SUFZbEIsQ0FBQztJQVYxQyxNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBdUI7UUFDaEQsSUFBSSxDQUFDLEdBQW9DLElBQUksSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFFbkUsS0FBSyxJQUFJLEdBQUcsSUFBSSxJ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L0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDO1FBQzdCLENBQUM7UUFFRCxnQkFBZ0I7WUFDZCxLQUFLLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQztZQUNyQyxJQUFJLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLEVBQUUsQ0FBQztRQUNuQyxDQUFDO1FBRUQsU0FBUztZQUNQLEtBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQztZQUM5QixJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUM7UUFDNUIsQ0FBQztRQUVELFNBQVM7WUFDUCxLQUFLLENBQUMsU0FBUyxDQUFDLEdBQUcsU0FBUyxDQUFDLENBQUM7WUFDOUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDO1FBQzVCLENBQUM7S0FDVyxDQUFDO0FBQ2pCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBUYWdXcmFwcGVyLFxuICBQYXRoUmVmZXJlbmNlLFxuICBjb21iaW5lLFxuICBVcGRhdGFibGVSZWZlcmVuY2UsXG4gIFRhZyxcbiAgVXBkYXRhYmxlRGlydHlhYmxlVGFnLFxufSBmcm9tICdAZ2xpbW1lci9yZWZlcmVuY2UnO1xuaW1wb3J0IHtcbiAgRGljdCxcbiAgT3B0aW9uLFxuICBCb3VuZHMsXG4gIENhcHR1cmVkTmFtZWRBcmd1bWVudHMsXG4gIENvbXBvbmVudE1hbmFnZXIsXG4gIFdpdGhKaXRTdGF0aWNMYXlvdXQsXG4gIEppdFJ1bnRpbWVSZXNvbHZlcixcbiAgQW90UnVudGltZVJlc29sdmVyLFxuICBXaXRoQW90U3RhdGljTGF5b3V0LFxuICBDb21wb25lbnRDYXBhYmlsaXRpZXMsXG4gIEVudmlyb25tZW50LFxuICBWTUFyZ3VtZW50cyxcbiAgRHluYW1pY1Njb3BlLFxuICBDb21waWxhYmxlUHJvZ3JhbSxcbiAgSW52b2NhdGlvbixcbiAgRGVzdHJveWFibGUsXG59IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsga2V5cywgdGVtcGxhdGVNZXRhLCBhc3NpZ24gfSBmcm9tICdAZ2xpbW1lci91dGlsJztcbmltcG9ydCB7IEJBU0lDX0NBUEFCSUxJVElFUyB9IGZyb20gJy4vY2FwYWJpbGl0aWVzJztcbmltcG9ydCB7IFRlc3RDb21wb25lbnREZWZpbml0aW9uU3RhdGUgfSBmcm9tICcuL3Rlc3QtY29tcG9uZW50JztcbmltcG9ydCB7IFRlc3RDb21wb25lbnRDb25zdHJ1Y3RvciB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgRW1iZXJpc2hDdXJseUNvbXBvbmVudEZhY3RvcnkgfSBmcm9tICcuL2VtYmVyaXNoLWN1cmx5JztcblxuZXhwb3J0IHR5cGUgQXR0cnMgPSBEaWN0O1xuZXhwb3J0IHR5cGUgQXR0cnNEaWZmID0geyBvbGRBdHRyczogT3B0aW9uPEF0dHJzPjsgbmV3QXR0cnM6IEF0dHJzIH07XG5leHBvcnQgdHlwZSBFbWJlcmlzaEdsaW1tZXJBcmdzID0geyBhdHRyczogQXR0cnMgfTtcblxuY29uc3QgU0VMRl9SRUYgPSBuZXcgV2Vha01hcDxFbWJlcmlzaEdsaW1tZXJDb21wb25lbnQsIFVwZGF0YWJsZVJlZmVyZW5jZT4oKTtcblxuZnVuY3Rpb24gZ2V0U2VsZihvYmo6IEVtYmVyaXNoR2xpbW1lckNvbXBvbmVudCk6IFVwZGF0YWJsZVJlZmVyZW5jZSB7XG4gIGlmIChTRUxGX1JFRi5oYXMob2JqKSkge1xuICAgIHJldHVybiBTRUxGX1JFRi5nZXQob2JqKSE7XG4gIH0gZWxzZSB7XG4gICAgbGV0IHJlZiA9IG5ldyBVcGRhdGFibGVSZWZlcmVuY2Uob2JqKTtcbiAgICBTRUxGX1JFRi5zZXQob2JqLCByZWYpO1xuICAgIHJldHVybiByZWY7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEVtYmVyaXNoR2xpbW1lckNvbXBvbmVudCB7XG4gIHB1YmxpYyBkaXJ0aW5lc3NUYWc6IFRhZ1dyYXBwZXI8VXBkYXRhYmxlRGlydHlhYmxlVGFnPiA9IFVwZGF0YWJsZURpcnR5YWJsZVRhZy5jcmVhdGUoKTtcbiAgcHVibGljIGF0dHJzITogQXR0cnM7XG4gIHB1YmxpYyBlbGVtZW50ITogRWxlbWVudDtcbiAgcHVibGljIGJvdW5kcyE6IEJvdW5kcztcbiAgcHVibGljIHBhcmVudFZpZXc6IE9wdGlvbjxFbWJlcmlzaEdsaW1tZXJDb21wb25lbnQ+ID0gbnVsbDtcblxuICBzdGF0aWMgY3JlYXRlKHsgYXR0cnM6IGFyZ3MgfTogRW1iZXJpc2hHbGltbWVyQXJncyk6IEVtYmVyaXNoR2xpbW1lckNvbXBvbmVudCB7XG4gICAgbGV0IGM6IEVtYmVyaXNoR2xpbW1lckNvbXBvbmVudCAmIERpY3QgPSBuZXcgdGhpcyh7IGF0dHJzOiBhcmdzIH0pO1xuXG4gICAgZm9yIChsZXQga2V5IG9mIGtleXMoYXJncykpIHtcbiAgICAgIGNba2V5XSA9IGFyZ3Nba2V5XTtcbiAgICB9XG5cbiAgICByZXR1cm4gYztcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKF9hcmdzOiBFbWJlcmlzaEdsaW1tZXJBcmdzKSB7fVxuXG4gIHJlY29tcHV0ZSgpIHtcbiAgICBnZXRTZWxmKHRoaXMpLmRpcnR5KCk7XG4gIH1cblxuICBkZXN0cm95KCkge31cblxuICBkaWRJbml0QXR0cnMoX29wdGlvbnM6IHsgYXR0cnM6IEF0dHJzIH0pIHt9XG4gIGRpZFVwZGF0ZUF0dHJzKF9kaWZmOiBBdHRyc0RpZmYpIHt9XG4gIGRpZFJlY2VpdmVBdHRycyhfZGlmZjogQXR0cnNEaWZmKSB7fVxuICB3aWxsSW5zZXJ0RWxlbWVudCgpIHt9XG4gIHdpbGxVcGRhdGUoKSB7fVxuICB3aWxsUmVuZGVyKCkge31cbiAgZGlkSW5zZXJ0RWxlbWVudCgpIHt9XG4gIGRpZFVwZGF0ZSgpIHt9XG4gIGRpZFJlbmRlcigpIHt9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRW1iZXJpc2hHbGltbWVyQ29tcG9uZW50RmFjdG9yeVxuICBleHRlbmRzIFRlc3RDb21wb25lbnRDb25zdHJ1Y3RvcjxFbWJlcmlzaEdsaW1tZXJDb21wb25lbnQ+IHtcbiAgY3JlYXRlKG9wdGlvbnM6IHsgYXR0cnM6IEF0dHJzIH0pOiBFbWJlcmlzaEdsaW1tZXJDb21wb25lbnQ7XG59XG5cbmV4cG9ydCBjb25zdCBFTUJFUklTSF9HTElNTUVSX0NBUEFCSUxJVElFUyA9IGFzc2lnbih7fSwgQkFTSUNfQ0FQQUJJTElUSUVTLCB7XG4gIGR5bmFtaWNUYWc6IHRydWUsXG4gIGNyZWF0ZUFyZ3M6IHRydWUsXG4gIGF0dHJpYnV0ZUhvb2s6IHRydWUsXG4gIHVwZGF0ZUhvb2s6IHRydWUsXG4gIGNyZWF0ZUluc3RhbmNlOiB0cnVlLFxufSk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRW1iZXJpc2hHbGltbWVyQ29tcG9uZW50U3RhdGUge1xuICBhcmdzOiBDYXB0dXJlZE5hbWVkQXJndW1lbnRzO1xuICBjb21wb25lbnQ6IEVtYmVyaXNoR2xpbW1lckNvbXBvbmVudDtcbn1cblxuZXhwb3J0IGNsYXNzIEVtYmVyaXNoR2xpbW1lckNvbXBvbmVudE1hbmFnZXJcbiAgaW1wbGVtZW50c1xuICAgIENvbXBvbmVudE1hbmFnZXI8RW1iZXJpc2hHbGltbWVyQ29tcG9uZW50U3RhdGUsIFRlc3RDb21wb25lbnREZWZpbml0aW9uU3RhdGU+LFxuICAgIFdpdGhKaXRTdGF0aWNMYXlvdXQ8XG4gICAgICBFbWJlcmlzaEdsaW1tZXJDb21wb25lbnRTdGF0ZSxcbiAgICAgIFRlc3RDb21wb25lbnREZWZpbml0aW9uU3RhdGUsXG4gICAgICBKaXRSdW50aW1lUmVzb2x2ZXJcbiAgICA+LFxuICAgIFdpdGhBb3RTdGF0aWNMYXlvdXQ8XG4gICAgICBFbWJlcmlzaEdsaW1tZXJDb21wb25lbnRTdGF0ZSxcbiAgICAgIFRlc3RDb21wb25lbnREZWZpbml0aW9uU3RhdGUsXG4gICAgICBBb3RSdW50aW1lUmVzb2x2ZXJcbiAgICA+IHtcbiAgZ2V0Q2FwYWJpbGl0aWVzKHN0YXRlOiBUZXN0Q29tcG9uZW50RGVmaW5pdGlvblN0YXRlKTogQ29tcG9uZW50Q2FwYWJpbGl0aWVzIHtcbiAgICByZXR1cm4gc3RhdGUuY2FwYWJpbGl0aWVzO1xuICB9XG5cbiAgcHJlcGFyZUFyZ3MoKTogbnVsbCB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBjcmVhdGUoXG4gICAgX2Vudmlyb25tZW50OiBFbnZpcm9ubWVudCxcbiAgICBkZWZpbml0aW9uOiBUZXN0Q29tcG9uZW50RGVmaW5pdGlvblN0YXRlLFxuICAgIF9hcmdzOiBWTUFyZ3VtZW50cyxcbiAgICBfZHluYW1pY1Njb3BlOiBEeW5hbWljU2NvcGUsXG4gICAgX2NhbGxlclNlbGY6IFBhdGhSZWZlcmVuY2U8dW5rbm93bj4sXG4gICAgX2hhc0RlZmF1bHRCbG9jazogYm9vbGVhblxuICApOiBFbWJlcmlzaEdsaW1tZXJDb21wb25lbnRTdGF0ZSB7XG4gICAgbGV0IGFyZ3MgPSBfYXJncy5uYW1lZC5jYXB0dXJlKCk7XG4gICAgbGV0IGtsYXNzID0gZGVmaW5pdGlvbi5Db21wb25lbnRDbGFzcyB8fCBFbWJlcmlzaEdsaW1tZXJDb21wb25lbnQ7XG4gICAgbGV0IGF0dHJzID0gYXJncy52YWx1ZSgpO1xuICAgIGxldCBjb21wb25lbnQgPSBrbGFzcy5jcmVhdGUoeyBhdHRycyB9KTtcblxuICAgIGNvbXBvbmVudC5kaWRJbml0QXR0cnMoeyBhdHRycyB9KTtcbiAgICBjb21wb25lbnQuZGlkUmVjZWl2ZUF0dHJzKHsgb2xkQXR0cnM6IG51bGwsIG5ld0F0dHJzOiBhdHRycyB9KTtcbiAgICBjb21wb25lbnQud2lsbEluc2VydEVsZW1lbnQoKTtcbiAgICBjb21wb25lbnQud2lsbFJlbmRlcigpO1xuXG4gICAgcmV0dXJuIHsgYXJncywgY29tcG9uZW50IH07XG4gIH1cblxuICBnZXRUYWcoeyBhcmdzOiB7IHRhZyB9LCBjb21wb25lbnQgfTogRW1iZXJpc2hHbGltbWVyQ29tcG9uZW50U3RhdGUpOiBUYWcge1xuICAgIHJldHVybiBjb21iaW5lKFt0YWcsIGdldFNlbGYoY29tcG9uZW50KS50YWddKTtcbiAgfVxuXG4gIGdldEppdFN0YXRpY0xheW91dChcbiAgICBzdGF0ZTogVGVzdENvbXBvbmVudERlZmluaXRpb25TdGF0ZSxcbiAgICByZXNvbHZlcjogSml0UnVudGltZVJlc29sdmVyXG4gICk6IENvbXBpbGFibGVQcm9ncmFtIHtcbiAgICByZXR1cm4gcmVzb2x2ZXIuY29tcGlsYWJsZSh0ZW1wbGF0ZU1ldGEoc3RhdGUubG9jYXRvcikpLmFzTGF5b3V0KCk7XG4gIH1cblxuICBnZXRBb3RTdGF0aWNMYXlvdXQoXG4gICAgc3RhdGU6IFRlc3RDb21wb25lbnREZWZpbml0aW9uU3RhdGUsXG4gICAgcmVzb2x2ZXI6IEFvdFJ1bnRpbWVSZXNvbHZlclxuICApOiBJbnZvY2F0aW9uIHtcbiAgICBsZXQgeyBsb2NhdG9yIH0gPSBzdGF0ZTtcblxuICAgIHJldHVybiByZXNvbHZlci5nZXRJbnZvY2F0aW9uKHRlbXBsYXRlTWV0YShsb2NhdG9yLm1ldGEubG9jYXRvcikpO1xuICB9XG5cbiAgZ2V0U2VsZih7IGNvbXBvbmVudCB9OiBFbWJlcmlzaEdsaW1tZXJDb21wb25lbnRTdGF0ZSk6IFBhdGhSZWZlcmVuY2U8dW5rbm93bj4ge1xuICAgIHJldHVybiBnZXRTZWxmKGNvbXBvbmVudCk7XG4gIH1cblxuICBkaWRDcmVhdGVFbGVtZW50KCk6IHZvaWQge31cblxuICBkaWRSZW5kZXJMYXlvdXQoeyBjb21wb25lbnQgfTogRW1iZXJpc2hHbGltbWVyQ29tcG9uZW50U3RhdGUsIGJvdW5kczogQm91bmRzKTogdm9pZCB7XG4gICAgY29tcG9uZW50LmJvdW5kcyA9IGJvdW5kcztcbiAgfVxuXG4gIGRpZENyZWF0ZSh7IGNvbXBvbmVudCB9OiBFbWJlcmlzaEdsaW1tZXJDb21wb25lbnRTdGF0ZSk6IHZvaWQge1xuICAgIGNvbXBvbmVudC5kaWRJbnNlcnRFbGVtZW50KCk7XG4gICAgY29tcG9uZW50LmRpZFJlbmRlcigpO1xuICB9XG5cbiAgdXBkYXRlKHsgYXJncywgY29tcG9uZW50IH06IEVtYmVyaXNoR2xpbW1lckNvbXBvbmVudFN0YXRlKTogdm9pZCB7XG4gICAgbGV0IG9sZEF0dHJzID0gY29tcG9uZW50LmF0dHJzO1xuICAgIGxldCBuZXdBdHRycyA9IGFyZ3MudmFsdWUoKTtcblxuICAgIGNvbXBvbmVudC5hdHRycyA9IG5ld0F0dHJzO1xuICAgIGNvbXBvbmVudC5kaWRVcGRhdGVBdHRycyh7IG9sZEF0dHJzLCBuZXdBdHRycyB9KTtcbiAgICBjb21wb25lbnQuZGlkUmVjZWl2ZUF0dHJzKHsgb2xkQXR0cnMsIG5ld0F0dHJzIH0pO1xuICAgIGNvbXBvbmVudC53aWxsVXBkYXRlKCk7XG4gICAgY29tcG9uZW50LndpbGxSZW5kZXIoKTtcbiAgfVxuXG4gIGRpZFVwZGF0ZUxheW91dCgpOiB2b2lkIHt9XG5cbiAgZGlkVXBkYXRlKHsgY29tcG9uZW50IH06IEVtYmVyaXNoR2xpbW1lckNvbXBvbmVudFN0YXRlKTogdm9pZCB7XG4gICAgY29tcG9uZW50LmRpZFVwZGF0ZSgpO1xuICAgIGNvbXBvbmVudC5kaWRSZW5kZXIoKTtcbiAgfVxuXG4gIGdldERlc3RydWN0b3IoeyBjb21wb25lbnQgfTogRW1iZXJpc2hHbGltbWVyQ29tcG9uZW50U3RhdGUpOiBEZXN0cm95YWJsZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGRlc3Ryb3koKSB7XG4gICAgICAgIGNvbXBvbmVudC5kZXN0cm95KCk7XG4gICAgICB9LFxuICAgIH07XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBDb21wb25lbnRIb29rcyB7XG4gIGRpZEluaXRBdHRyczogbnVtYmVyO1xuICBkaWRVcGRhdGVBdHRyczogbnVtYmVyO1xuICBkaWRSZWNlaXZlQXR0cnM6IG51bWJlcjtcbiAgd2lsbEluc2VydEVsZW1lbnQ6IG51bWJlcjtcbiAgd2lsbFVwZGF0ZTogbnVtYmVyO1xuICB3aWxsUmVuZGVyOiBudW1iZXI7XG4gIGRpZEluc2VydEVsZW1lbnQ6IG51bWJlcjtcbiAgZGlkVXBkYXRlOiBudW1iZXI7XG4gIGRpZFJlbmRlcjogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEhvb2tlZENvbXBvbmVudCB7XG4gIGhvb2tzOiBDb21wb25lbnRIb29rcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGluc3BlY3RIb29rczxcbiAgVCBleHRlbmRzIEVtYmVyaXNoQ3VybHlDb21wb25lbnRGYWN0b3J5IHwgRW1iZXJpc2hHbGltbWVyQ29tcG9uZW50RmFjdG9yeVxuPihDb21wb25lbnRDbGFzczogVCk6IFQge1xuICByZXR1cm4gKGNsYXNzIGV4dGVuZHMgKENvbXBvbmVudENsYXNzIGFzIGFueSkge1xuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgc3VwZXIoKTtcblxuICAgICAgdGhpcy5ob29rcyA9IHtcbiAgICAgICAgZGlkSW5pdEF0dHJzOiAwLFxuICAgICAgICBkaWRVcGRhdGVBdHRyczogMCxcbiAgICAgICAgZGlkUmVjZWl2ZUF0dHJzOiAwLFxuICAgICAgICB3aWxsSW5zZXJ0RWxlbWVudDogMCxcbiAgICAgICAgd2lsbFVwZGF0ZTogMCxcbiAgICAgICAgd2lsbFJlbmRlcjogMCxcbiAgICAgICAgZGlkSW5zZXJ0RWxlbWVudDogMCxcbiAgICAgICAgZGlkVXBkYXRlOiAwLFxuICAgICAgICBkaWRSZW5kZXI6IDAsXG4gICAgICB9O1xuICAgIH1cblxuICAgIGRpZEluaXRBdHRycyh0aGlzOiBhbnkpIHtcbiAgICAgIHN1cGVyLmRpZEluaXRBdHRycyguLi5hcmd1bWVudHMpO1xuICAgICAgdGhpcy5ob29rc1snZGlkSW5pdEF0dHJzJ10rKztcbiAgICB9XG5cbiAgICBkaWRVcGRhdGVBdHRycyh0aGlzOiBhbnkpIHtcbiAgICAgIHN1cGVyLmRpZFVwZGF0ZUF0dHJzKC4uLmFyZ3VtZW50cyk7XG4gICAgICB0aGlzLmhvb2tzWydkaWRVcGRhdGVBdHRycyddKys7XG4gICAgfVxuXG4gICAgZGlkUmVjZWl2ZUF0dHJzKHRoaXM6IGFueSkge1xuICAgICAgc3VwZXIuZGlkUmVjZWl2ZUF0dHJzKC4uLmFyZ3VtZW50cyk7XG4gICAgICB0aGlzLmhvb2tzWydkaWRSZWNlaXZlQXR0cnMnXSsrO1xuICAgIH1cblxuICAgIHdpbGxJbnNlcnRFbGVtZW50KHRoaXM6IGFueSkge1xuICAgICAgc3VwZXIud2lsbEluc2VydEVsZW1lbnQoLi4uYXJndW1lbnRzKTtcbiAgICAgIHRoaXMuaG9va3NbJ3dpbGxJbnNlcnRFbGVtZW50J10rKztcbiAgICB9XG5cbiAgICB3aWxsVXBkYXRlKHRoaXM6IGFueSkge1xuICAgICAgc3VwZXIud2lsbFVwZGF0ZSguLi5hcmd1bWVudHMpO1xuICAgICAgdGhpcy5ob29rc1snd2lsbFVwZGF0ZSddKys7XG4gICAgfVxuXG4gICAgd2lsbFJlbmRlcih0aGlzOiBhbnkpIHtcbiAgICAgIHN1cGVyLndpbGxSZW5kZXIoLi4uYXJndW1lbnRzKTtcbiAgICAgIHRoaXMuaG9va3NbJ3dpbGxSZW5kZXInXSsrO1xuICAgIH1cblxuICAgIGRpZEluc2VydEVsZW1lbnQodGhpczogYW55KSB7XG4gICAgICBzdXBlci5kaWRJbnNlcnRFbGVtZW50KC4uLmFyZ3VtZW50cyk7XG4gICAgICB0aGlzLmhvb2tzWydkaWRJbnNlcnRFbGVtZW50J10rKztcbiAgICB9XG5cbiAgICBkaWRVcGRhdGUodGhpczogYW55KSB7XG4gICAgICBzdXBlci5kaWRVcGRhdGUoLi4uYXJndW1lbnRzKTtcbiAgICAgIHRoaXMuaG9va3NbJ2RpZFVwZGF0ZSddKys7XG4gICAgfVxuXG4gICAgZGlkUmVuZGVyKHRoaXM6IGFueSkge1xuICAgICAgc3VwZXIuZGlkUmVuZGVyKC4uLmFyZ3VtZW50cyk7XG4gICAgICB0aGlzLmhvb2tzWydkaWRSZW5kZXInXSsrO1xuICAgIH1cbiAgfSBhcyBhbnkpIGFzIFQ7XG59XG4iXX0=